<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã„ãã‚‚ã®ã‚³ãƒã‚¯ãƒˆï¼†ã•ãŒã—</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=M+PLUS+Rounded+1c:wght@700;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'M PLUS Rounded 1c', 'Inter', sans-serif;
            touch-action: manipulation;
        }

        /* --- å…±é€šã‚¹ã‚¿ã‚¤ãƒ« --- */
        .screen {
            display: none;
            width: 100%;
            min-height: 100vh;
            padding: 20px;
        }
        .screen.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .game-title {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }
        @media (min-width: 640px) {
            .game-title { font-size: 3.5rem; }
        }
        .game-subtitle {
            font-size: 1.1rem;
            color: #4b5563; /* gray-600 */
            margin-bottom: 2rem;
        }
        @media (min-width: 640px) {
            .game-subtitle { font-size: 1.25rem; }
        }
        .game-button {
            width: 100%;
            color: white;
            font-weight: 700;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem; /* 12px */
            font-size: 1.25rem; /* 20px */
            transition: all 0.2s;
            transform: scale(1);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .game-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        /* --- ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º (3ã‚«ãƒ©ãƒ ) --- */
        #ranking-section .rank-column h4 {
            font-size: 1.1rem; /* ã‹ã‚“ãŸã‚“/ãµã¤ã†/ã‚€ãšã‹ã—ã„ ã®æ–‡å­—ã‚µã‚¤ã‚º */
            font-weight: 700;
            text-align: center;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 3px solid;
        }
        #ranking-section ol {
            list-style-type: decimal;
            list-style-position: inside;
            text-align: left;
            height: 12rem; /* 192px */
            overflow-y: auto;
            background-color: #f9fafb; /* gray-50 */
            padding: 0.75rem; /* 12px */
            border-radius: 0.5rem; /* 8px */
            border: 1px solid #e5e7eb; /* gray-200 */
        }
        #ranking-section li {
            font-size: 0.9rem; /* ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®æ–‡å­—ã‚µã‚¤ã‚º */
            padding: 0.1rem 0.25rem;
            border-radius: 4px;
        }
        @media (min-width: 640px) {
             #ranking-section li {
                font-size: 1rem; /* 16px */
             }
        }
        #ranking-section li:nth-child(odd) {
            background-color: #ffffff; /* white */
        }
        #ranking-section li .rank-name {
            font-weight: 700;
            color: #1f2937; /* gray-800 */
            display: inline-block;
            max-width: 60%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            vertical-align: bottom;
        }
        #ranking-section li .rank-time {
            float: right;
            font-weight: 700;
            color: #1d4ed8; /* blue-700 */
        }
        /* 1ä½ */
        #ranking-section li:nth-child(1) { 
            background-color: #fef9c3; /* yellow-100 */
        }
        #ranking-section li:nth-child(1) .rank-name {
            color: #ca8a04; /* yellow-600 */
        }

        /* --- ã‚³ãƒã‚¯ãƒˆã‚²ãƒ¼ãƒ ï¼ˆç¥çµŒè¡°å¼±ï¼‰ã‚¹ã‚¿ã‚¤ãƒ« --- */
        .card {
            width: 100%;
            aspect-ratio: 1 / 1;
            perspective: 1000px;
            cursor: pointer;
        }
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .card.is-flipped .card-inner {
            transform: rotateY(180deg);
        }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .card-back {
            background-color: #4ade80; /* green-400 */
            color: white;
            font-size: 3rem;
        }
        .card-front {
            background-color: #f0fdf4; /* green-50 */
            color: #166534; /* green-800 */
            font-size: 2.5rem;
            transform: rotateY(180deg);
            padding: 8px;
            line-height: 1;
        }
        .card.is-matched {
            opacity: 0.3;
            pointer-events: none;
        }
        /* ãƒ’ãƒ³ãƒˆç”¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .card.is-hinting .card-back {
            animation: hint-blink 0.5s 3;
        }
        @keyframes hint-blink {
            50% {
                transform: scale(1.1);
                background-color: #fde047; /* yellow-400 */
            }
        }

        /* ã‚°ãƒªãƒƒãƒ‰ */
        .grid-tutorial { grid-template-columns: repeat(2, 1fr); max-width: 200px; }
        .grid-easy { grid-template-columns: repeat(4, 1fr); }
        .grid-medium { grid-template-columns: repeat(4, 1fr); }
        .grid-hard { grid-template-columns: repeat(5, 1fr); }
        @media (max-width: 640px) {
            .card-back { font-size: 2rem; }
            .card-front { font-size: 1.8rem; }
            .grid-tutorial { max-width: 150px; }
            .grid-easy { grid-template-columns: repeat(3, 1fr); }
            .grid-medium { grid-template-columns: repeat(4, 1fr); }
            .grid-hard { grid-template-columns: repeat(4, 1fr); }
        }

        /* --- ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€š --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; /* JSã§åˆ¶å¾¡ */
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 20px;
        }
        /* ç°¡æ˜“ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã›ã„ã‹ã„/ã–ã‚“ã­ã‚“ï¼‰ */
        #simple-modal-content {
            padding: 30px 40px;
            border-radius: 16px;
            color: white;
            font-size: 2.5rem;
            font-weight: 800;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.4);
        }
        #simple-modal-content.success {
            background: linear-gradient(135deg, #68d391, #38a169); /* green */
        }
        #simple-modal-content.error {
            background: linear-gradient(135deg, #fc8181, #e53e3e); /* red */
        }
        /* è§£èª¬ãƒ¢ãƒ¼ãƒ€ãƒ« */
        #explanation-modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        #explanation-text {
            font-size: 1.25rem;
            color: #1f2937;
            margin-bottom: 24px;
            line-height: 1.6;
        }
        /* ãƒ©ãƒ³ã‚¯ã‚¤ãƒ³å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« */
        #ranking-modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        /* â˜… ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« */
        #confirm-modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }


        /* --- ã„ãã‚‚ã®ã•ãŒã—ã‚²ãƒ¼ãƒ  ã‚¹ã‚¿ã‚¤ãƒ« --- */
        #find-game-area {
            width: 100%;
            max-width: 800px;
            height: 65vh;
            border-radius: 12px;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
            border: 4px solid #86efac; /* green-300 */
        }
        #find-game-svg {
            width: 100%;
            height: 100%;
        }
        .target-animal {
            cursor: pointer;
            transition: opacity 0.3s ease, transform 0.2s ease;
            opacity: 0.9; /* å°‘ã—ã ã‘é€æ˜ã«ã—ã¦æ¢ã—ã«ãã */
        }
        .target-animal:hover {
            opacity: 1;
            transform: scale(1.2);
            stroke: #fef08a; /* yellow-200 */
            stroke-width: 2px;
        }
        .target-animal.is-found {
            opacity: 0.3;
            pointer-events: none;
        }
        #find-game-targets {
            display: flex;
            flex-direction: column; /* ç¸¦ä¸¦ã³ã«å¤‰æ›´ */
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 20px;
            padding: 12px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            max-width: 800px;
            width: 100%;
            position: relative; /* â˜… ãŠã‚ã‚‹ãƒœã‚¿ãƒ³é…ç½®ã®ãŸã‚ */
        }
        .target-item {
            font-size: 1.1rem;
            font-weight: 700;
            color: #6b7280; /* gray-500 */
            transition: all 0.3s;
        }
        .target-item.is-found {
            color: #10b981; /* green-500 */
            text-decoration: line-through;
        }
        /* è§£èª¬ã‚¨ãƒªã‚¢ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .explanation-list {
            text-align: left;
            background: #f9fafb; /* gray-50 */
            padding: 1rem 1.5rem;
            border-radius: 0.5rem; /* 8px */
            max-height: 16rem; /* 256px */
            overflow-y: auto;
            margin-bottom: 2rem;
            border: 1px solid #e5e7eb; /* gray-200 */
        }
        .explanation-list h3 {
            font-size: 1.5rem; /* 24px */
            font-weight: 700;
            color: #166534; /* green-800 */
            margin-bottom: 1rem;
        }
        .explanation-list div {
            font-size: 1.1rem; /* 18px */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- â˜… BGMç”¨ audio ã‚¿ã‚° (å‰Šé™¤) -->
    <!-- <audio id="bg-music" src="music.mp3" loop></audio> --> <!-- â˜… å‰Šé™¤ã—ã¾ã—ãŸ -->

    <div id="app">

        <!-- 0. ã‚²ãƒ¼ãƒ é¸æŠç”»é¢ -->
        <div id="game-select-screen" class="screen active">
             <!-- â˜… relative ã‚’å‰Šé™¤ã—ã¾ã—ãŸ -->
            <div class="text-center p-6 bg-white rounded-2xl shadow-xl max-w-lg w-full">
                <!-- â˜… å¤ã„ãƒŸãƒ¥ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’å‰Šé™¤ã—ã¾ã—ãŸ -->
                <h1 class="game-title text-green-700">ã„ãã‚‚ã® ãƒ¯ãƒ¼ãƒ«ãƒ‰</h1>
                <p class="game-subtitle">ã©ã¡ã‚‰ã®ã‚²ãƒ¼ãƒ ã§ã‚ãã¶ï¼Ÿ</p>
                
                <div class="space-y-4">
                    <button id="select-connect-game" class="game-button bg-blue-500 hover:bg-blue-600">
                        ğŸ¤ ã„ãã‚‚ã®ã‚³ãƒã‚¯ãƒˆï¼
                    </button>
                    <button id="select-find-game" class="game-button bg-yellow-500 hover:bg-yellow-600">
                        ğŸ‘€ ã„ãã‚‚ã® ã‹ãã‚Œã‚“ã¼
                    </button>
                </div>
            </div>
        </div>

        <!-- 1. ã‚³ãƒã‚¯ãƒˆã‚²ãƒ¼ãƒ  ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
        <div id="connect-start-screen" class="screen">
            <div class="text-center p-6 bg-white rounded-2xl shadow-xl max-w-3xl w-full">
                <h1 class="game-title text-blue-600">ã„ãã‚‚ã®ã‚³ãƒã‚¯ãƒˆï¼</h1>
                <p class="game-subtitle">ã¿ã¢ã‹ãª ãªã‹ã¾ã‚’ ã¿ã¤ã‘ã‚ˆã†</p>

                <!-- â˜…â˜…â˜… 3ã‚«ãƒ©ãƒ  ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ â˜…â˜…â˜… -->
                <div id="ranking-section" class="w-full mb-6">
                    <h3 class="text-2xl font-bold text-gray-700 mb-4">ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚° ğŸ†</h3>
                    <div class="flex flex-col sm:flex-row justify-between space-y-4 sm:space-y-0 sm:space-x-4">
                        
                        <!-- ã‹ã‚“ãŸã‚“ -->
                        <div class="flex-1 rank-column">
                            <h4 class="text-blue-600 border-blue-500">-- ã‹ã‚“ãŸã‚“ --</h4>
                            <ol id="ranking-list-easy">
                                <!-- JSã§æŒ¿å…¥ -->
                            </ol>
                        </div>
                        
                        <!-- ãµã¤ã† -->
                        <div class="flex-1 rank-column">
                            <h4 class="text-yellow-600 border-yellow-500">-- ãµã¤ã† --</h4>
                            <ol id="ranking-list-medium">
                                <!-- JSã§æŒ¿å…¥ -->
                            </ol>
                        </div>
                        
                        <!-- ã‚€ãšã‹ã—ã„ -->
                        <div class="flex-1 rank-column">
                            <h4 class="text-red-600 border-red-500">-- ã‚€ãšã‹ã—ã„ --</h4>
                            <ol id="ranking-list-hard">
                                <!-- JSã§æŒ¿å…¥ -->
                            </ol>
                        </div>

                    </div>
                </div>
                <!-- â˜…â˜…â˜… ã“ã“ã¾ã§ â˜…â˜…â˜… -->
                
                <div class="space-y-4">
                    <button data-difficulty="tutorial" class="difficulty-btn game-button bg-green-500 hover:bg-green-600">
                        ãŠãŸã‚ã— (2ãƒšã‚¢)
                    </button>
                    <button data-difficulty="easy" class="difficulty-btn game-button bg-blue-500 hover:bg-blue-600">
                        ã‹ã‚“ãŸã‚“ (6ãƒšã‚¢)
                    </button>
                    <button data-difficulty="medium" class="difficulty-btn game-button bg-yellow-500 hover:bg-yellow-600">
                        ãµã¤ã† (8ãƒšã‚¢)
                    </button>
                    <button data-difficulty="hard" class="difficulty-btn game-button bg-red-500 hover:bg-red-600">
                        ã‚€ãšã‹ã—ã„ (10ãƒšã‚¢)
                    </button>
                    <button id="connect-back-button" class="game-button bg-gray-400 hover:bg-gray-500 mt-6">
                        ã‚‚ã©ã‚‹
                    </button>
                </div>
            </div>
        </div>

        <!-- 2. ã‚³ãƒã‚¯ãƒˆã‚²ãƒ¼ãƒ  ã‚²ãƒ¼ãƒ ç”»é¢ -->
        <div id="connect-game-screen" class="screen">
            <div class="w-full max-w-3xl mx-auto">
                <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-md mb-6">
                    <div>
                        <span class="text-lg font-bold text-gray-600">ã®ã“ã‚Šãƒšã‚¢:</span>
                        <span id="pairs-left" class="text-2xl font-extrabold text-blue-700">0</span>
                    </div>
                    <div>
                        <span class="text-lg font-bold text-gray-600">ã˜ã‹ã‚“:</span>
                        <span id="timer" class="text-2xl font-extrabold text-red-600">0</span>
                    </div>
                    <!-- â˜… ãŠã‚ã‚‹ãƒœã‚¿ãƒ³è¿½åŠ  -->
                    <button id="connect-quit-game" class="text-sm font-bold bg-gray-200 text-gray-600 px-3 py-2 rounded-lg hover:bg-gray-300">
                        ãŠã‚ã‚‹
                    </button>
                </div>

                <div id="connect-game-board" class="grid gap-2 sm:gap-4">
                    <!-- ã‚«ãƒ¼ãƒ‰ã¯JSã§ç”Ÿæˆã•ã‚Œã¾ã™ -->
                </div>
            </div>
        </div>

        <!-- 3. ã‚³ãƒã‚¯ãƒˆã‚²ãƒ¼ãƒ  çµæœãƒ»è§£èª¬ç”»é¢ -->
        <div id="connect-result-screen" class="screen">
            <div class="text-center p-6 sm:p-10 bg-white rounded-2xl shadow-xl max-w-2xl w-full">
                <h2 id="connect-result-title" class="text-5xl font-extrabold text-yellow-500 mb-4">ã‚¯ãƒªã‚¢ï¼</h2>
                <p id="connect-result-time" class="text-2xl text-gray-700 mb-8">ã‹ã‹ã£ãŸã˜ã‹ã‚“: 60ã³ã‚‡ã†</p>
                
                <div class="explanation-list">
                    <h3>ã¿ã¤ã‘ãŸã€Œã¤ãªãŒã‚Šã€ã„ã¡ã‚‰ã‚“</h3>
                    <div id="connect-explanation-area" class="space-y-4">
                        <!-- è§£èª¬ã¯JSã§ç”Ÿæˆã•ã‚Œã¾ã™ -->
                    </div>
                </div>

                <button id="connect-restart-button" class="game-button bg-green-500 hover:bg-green-600">
                    ã‚‚ã†ã„ã¡ã© ã‚ãã¶
                </button>
            </div>
        </div>

        <!-- 4. ã•ãŒã—ã‚²ãƒ¼ãƒ  ã‚²ãƒ¼ãƒ ç”»é¢ -->
        <div id="find-game-screen" class="screen">
            <div class="w-full max-w-3xl mx-auto flex flex-col items-center">
                <h1 class="game-title text-yellow-600">ã„ãã‚‚ã® ã‹ãã‚Œã‚“ã¼</h1>
                <p class="game-subtitle">ã¿ã¤ã‘ã‚‰ã‚Œã‚‹ã‹ãªï¼Ÿ</p>
                
                <div id="find-game-targets">
                    <!-- ã•ãŒã™å¯¾è±¡ãƒªã‚¹ãƒˆãŒJSã§å…¥ã‚Šã¾ã™ -->
                    <!-- â˜… ãŠã‚ã‚‹ãƒœã‚¿ãƒ³è¿½åŠ  -->
                    <button id="find-quit-game" class="absolute top-2 right-2 text-sm font-bold bg-gray-200 text-gray-600 px-3 py-2 rounded-lg hover:bg-gray-300">
                        ãŠã‚ã‚‹
                    </button>
                </div>
                
                <div id="find-game-area">
                    <svg id="find-game-svg" viewBox="0 0 400 300" preserveAspectRatio="xMidYMid slice">
                        <!-- SVGèƒŒæ™¯ã¨å‹•ç‰©ãŒJSã§å…¥ã‚Šã¾ã™ -->
                    </svg>
                </div>
            </div>
        </div>
        
        <!-- 5. ã•ãŒã—ã‚²ãƒ¼ãƒ  çµæœç”»é¢ -->
        <div id="find-result-screen" class="screen">
            <div class="text-center p-6 sm:p-10 bg-white rounded-2xl shadow-xl max-w-2xl w-full">
                <h2 id="find-result-title" class="text-5xl font-extrabold text-yellow-500 mb-4">ãœã‚“ã¶ ã¿ã¤ã‘ãŸï¼</h2>
                <p id="find-result-message" class="text-2xl text-gray-700 mb-8">ã™ã”ã„ã­ï¼ã‹ã‚“ã•ã¤ ã‚ã„ã˜ã‚“ï¼</p>
                
                <div class="explanation-list">
                    <h3>ã¿ã¤ã‘ãŸã€Œã‹ãã‚Œã‚“ã¼ã€ã® ã²ã¿ã¤</h3>
                    <div id="find-explanation-area" class="space-y-4">
                        <!-- è§£èª¬ã¯JSã§ç”Ÿæˆã•ã‚Œã¾ã™ -->
                    </div>
                </div>

                <div class="space-y-4">
                    <button id="find-restart-button" class="game-button bg-green-500 hover:bg-green-600">
                        ã‚‚ã†ã„ã¡ã© ã‚ãã¶
                    </button>
                    <button id="find-back-button" class="game-button bg-gray-400 hover:bg-gray-500">
                        ã‚²ãƒ¼ãƒ ã‚’ ãˆã‚‰ã¶
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- å…±é€šãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã›ã„ã‹ã„/ã–ã‚“ã­ã‚“/ãƒ’ãƒ³ãƒˆï¼‰ -->
    <div id="simple-modal-overlay" class="modal-overlay">
        <div id="simple-modal-content" class="">
            <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯JSã§è¨­å®š -->
        </div>
    </div>
    
    <!-- å…±é€š è§£èª¬ãƒ¢ãƒ¼ãƒ€ãƒ« (ã‚³ãƒã‚¯ãƒˆ/ã•ãŒã— ä¸¡æ–¹ã§ä½¿ã†) -->
    <div id="explanation-modal-overlay" class="modal-overlay">
        <div id="explanation-modal-content">
            <p id="explanation-text">ã“ã“ã«è§£èª¬ãŒå…¥ã‚Šã¾ã™ã€‚</p>
            <button id="explanation-close-btn" class="game-button bg-blue-500 hover:bg-blue-600">
                ã¤ãã¸
            </button>
        </div>
    </div>

    <!-- ãƒ©ãƒ³ã‚¯ã‚¤ãƒ³å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="ranking-modal-overlay" class="modal-overlay">
        <div id="ranking-modal-content">
            <h2 class="text-3xl font-extrabold text-yellow-500 mb-3">ğŸ‰ãƒ©ãƒ³ã‚¯ã‚¤ãƒ³ï¼ğŸ‰</h2>
            <p id="ranking-modal-time" class="text-xl text-gray-700 mb-4">ã‚¿ã‚¤ãƒ : 00 ã³ã‚‡ã†</p>
            <p class="text-lg text-gray-600 mb-4">10ã„ ã„ãªã„ ã§ã™ï¼<br>ãªã¾ãˆã‚’ ã«ã‚…ã†ã‚Šã‚‡ã ã—ã¦ãã ã•ã„ã€‚</p>
            <input type="text" id="player-name-input" class="w-full p-3 border border-gray-300 rounded-lg text-lg" placeholder="ãªã¾ãˆ (8ã‚‚ã˜ ã¾ã§)" maxlength="8">
            <button id="ranking-submit-btn" class="game-button bg-green-500 hover:bg-green-600 mt-5">
                ã¨ã†ã‚ã
            </button>
        </div>
    </div>

    <!-- â˜… ã‚²ãƒ¼ãƒ çµ‚äº† ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="confirm-modal-overlay" class="modal-overlay">
        <div id="confirm-modal-content">
            <h3 class="text-xl font-bold mb-4">ã»ã‚“ã¨ã†ã« ãŠã‚ã‚Šã¾ã™ã‹ï¼Ÿ</h3>
            <p class="text-gray-600 mb-6">ã„ã¾ã®ã‚²ãƒ¼ãƒ ã¯ ããˆã¦ã—ã¾ã„ã¾ã™ã€‚</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-btn" class="game-button bg-gray-400 hover:bg-gray-500" style="width: 48%;">ã¤ã¥ã‘ã‚‹</button>
                <button id="confirm-ok-btn" class="game-button bg-red-500 hover:bg-red-600" style="width: 48%;">ãŠã‚ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- â˜… BGMç”¨ (Muteãƒœã‚¿ãƒ³ã¨Audioã‚¿ã‚°) -->
    <button id="mute-toggle-btn" class="fixed bottom-4 right-4 bg-white p-3 rounded-full shadow-lg z-50 text-xl">
        ğŸµ
    </button>
    <audio id="bgm" loop src="music.mp3"></audio>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 0. å…±é€š DOM ã¨ãƒ­ã‚¸ãƒƒã‚¯ ---
            const screens = {
                gameSelect: document.getElementById('game-select-screen'),
                connectStart: document.getElementById('connect-start-screen'),
                connectGame: document.getElementById('connect-game-screen'),
                connectResult: document.getElementById('connect-result-screen'),
                findGame: document.getElementById('find-game-screen'),
                findResult: document.getElementById('find-result-screen'),
            };
            
            <!-- â˜… å¤ã„BGMé–¢é€£ã®DOMå–å¾—ã‚’å‰Šé™¤ã—ã¾ã—ãŸ -->
            
            const simpleModalOverlay = document.getElementById('simple-modal-overlay');
            const simpleModalContent = document.getElementById('simple-modal-content');
            
            // å…±é€šè§£èª¬ãƒ¢ãƒ¼ãƒ€ãƒ«
            const explanationModal = document.getElementById('explanation-modal-overlay');
            const explanationText = document.getElementById('explanation-text');
            const explanationCloseBtn = document.getElementById('explanation-close-btn');

            // â˜… ãƒ©ãƒ³ã‚­ãƒ³ã‚°é–¢é€£ DOM
            const rankingModalOverlay = document.getElementById('ranking-modal-overlay');
            const rankingModalTime = document.getElementById('ranking-modal-time');
            const playerNameInput = document.getElementById('player-name-input');
            const rankingSubmitBtn = document.getElementById('ranking-submit-btn');

            // â˜… ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« DOM
            const confirmModalOverlay = document.getElementById('confirm-modal-overlay');
            const confirmOkBtn = document.getElementById('confirm-ok-btn');
            const confirmCancelBtn = document.getElementById('confirm-cancel-btn');

            // â˜… BGM DOM
            const bgm = document.getElementById('bgm');
            const muteToggleBtn = document.getElementById('mute-toggle-btn');
            
            // localStorageç”¨ã‚­ãƒ¼
            const RANKING_KEY = 'biodiversityGameRanking';

            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            function showScreen(screenId) {
                Object.values(screens).forEach(screen => screen.classList.remove('active'));
                screens[screenId].classList.add('active');

                <!-- â˜… BGMå†ç”Ÿ/åœæ­¢ (bgMusic ã‚’ bgm ã«ä¿®æ­£) -->
                if (screenId === 'connectGame' || screenId === 'findGame') {
                    // ã‚²ãƒ¼ãƒ ç”»é¢ã§å†ç”Ÿ
                    if (!bgm.muted) {
                        bgm.play().catch(e => console.log("BGMå†ç”Ÿã‚¨ãƒ©ãƒ¼: ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãŒå¿…è¦ã§ã™ã€‚"));
                    }
                } else {
                    // ãã‚Œä»¥å¤–ã®ç”»é¢ã§åœæ­¢
                    bgm.pause();
                    bgm.currentTime = 0;
                }
            }

            // ç°¡æ˜“ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼ˆã›ã„ã‹ã„/ã–ã‚“ã­ã‚“/ãƒ’ãƒ³ãƒˆï¼‰
            function showSimpleModal(message, type, duration = 1000) {
                simpleModalContent.textContent = message;
                simpleModalContent.className = type === 'success' ? 'success' : 'error';
                simpleModalOverlay.style.display = 'flex';
                
                // â˜… å¤‰æ›´ç‚¹: ã–ã‚“ã­ã‚“ ã®è¡¨ç¤ºæ™‚é–“ã‚’ 800ms ã«çŸ­ç¸®
                const actualDuration = (type === 'error') ? 800 : duration;
                setTimeout(hideSimpleModal, actualDuration);
            }
            
            function hideSimpleModal() {
                simpleModalOverlay.style.display = 'none';
            }

            // â˜… BGMå†ç”Ÿ/åœæ­¢/ãƒŸãƒ¥ãƒ¼ãƒˆ
            function playBGM() {
                if (bgm.paused) {
                    bgm.play().catch(e => console.log("BGM play failed:", e));
                }
            }
            function pauseBGM() {
                bgm.pause();
            }
            muteToggleBtn.addEventListener('click', () => {
                bgm.muted = !bgm.muted;
                muteToggleBtn.textContent = bgm.muted ? 'ğŸ”‡' : 'ğŸµ';
            });

            // ã‚²ãƒ¼ãƒ é¸æŠãƒœã‚¿ãƒ³ã®ãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('select-connect-game').addEventListener('click', () => showScreen('connectStart'));
            document.getElementById('select-find-game').addEventListener('click', () => initFindGame());
            document.getElementById('connect-back-button').addEventListener('click', () => {
                showScreen('gameSelect');
                pauseBGM(); // â˜… BGMåœæ­¢
            });


            // â˜… ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—
            function getRanking(difficulty) {
                const rankings = JSON.parse(localStorage.getItem(RANKING_KEY) || '{}');
                return rankings[difficulty] || [];
            }

            // â˜… ãƒ©ãƒ³ã‚­ãƒ³ã‚°ä¿å­˜
            function saveRanking(difficulty, name, time) {
                const rankings = JSON.parse(localStorage.getItem(RANKING_KEY) || '{}');
                const currentRank = rankings[difficulty] || [];
                
                currentRank.push({ name: name, time: time });
                currentRank.sort((a, b) => a.time - b.time); // ã‚¿ã‚¤ãƒ ã®æ˜‡é †ã§ã‚½ãƒ¼ãƒˆ
                
                rankings[difficulty] = currentRank.slice(0, 10); // ä¸Šä½10ä»¶ã®ã¿ä¿å­˜
                
                localStorage.setItem(RANKING_KEY, JSON.stringify(rankings));
            }

            // â˜… ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º (3ã‚«ãƒ©ãƒ åŒæ™‚)
            function displayRanking() {
                const difficulties = ['easy', 'medium', 'hard'];
                
                difficulties.forEach(difficulty => {
                    const listEl = document.getElementById(`ranking-list-${difficulty}`);
                    if (!listEl) return; // è¦ç´ ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                    
                    const rankData = getRanking(difficulty);
                    listEl.innerHTML = ''; // ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢

                    if (rankData.length === 0) {
                        listEl.innerHTML = '<li class="text-gray-500 text-center" style="list-style-type: none;">ã¾ã  ã¨ã†ã‚ã ãŒãªã„ã‚ˆ</li>';
                        return; // â˜…â˜…â˜… ä¿®æ­£: 'continue' ã‚’ 'return' ã«å¤‰æ›´ (forEach ã®ãŸã‚)
                    }

                    rankData.forEach((record, index) => {
                        const li = document.createElement('li');
                        // 1ä½ã‹ã‚‰3ä½ã«ãƒ¡ãƒ€ãƒ«
                        let medal = '';
                        if (index === 0) medal = 'ğŸ¥‡ ';
                        else if (index === 1) medal = 'ğŸ¥ˆ ';
                        else if (index === 2) medal = 'ğŸ¥‰ ';
                        
                        // XSSå¯¾ç­– (ç°¡æ˜“)
                        const safeName = document.createTextNode(record.name).textContent;
                        
                        li.innerHTML = `
                            <span class="rank-name">${medal}${safeName}</span>
                            <span class="rank-time">${record.time} ã³ã‚‡ã†</span>
                        `;
                        listEl.appendChild(li);
                    });
                });
            }

            // --- 1. ã„ãã‚‚ã®ã‚³ãƒã‚¯ãƒˆï¼ (ç¥çµŒè¡°å¼±) ---

            // ã‚³ãƒã‚¯ãƒˆã‚²ãƒ¼ãƒ  DOM
            const connectDoms = {
                difficultyButtons: document.querySelectorAll('.difficulty-btn'),
                gameBoard: document.getElementById('connect-game-board'),
                pairsLeftEl: document.getElementById('pairs-left'),
                timerEl: document.getElementById('timer'),
                resultTitle: document.getElementById('connect-result-title'),
                resultTime: document.getElementById('connect-result-time'),
                explanationArea: document.getElementById('connect-explanation-area'),
                restartButton: document.getElementById('connect-restart-button'),
                quitButton: document.getElementById('connect-quit-game'), // â˜… è¿½åŠ 
            };

            // ã‚³ãƒã‚¯ãƒˆã‚²ãƒ¼ãƒ  ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿
            const allPairs = {
                // Tutorial
                'T1': [{ emoji: 'ğŸ¶', name: 'ã‚¤ãƒŒ' }, { emoji: 'ğŸ¦´', name: 'ãƒ›ãƒ' }],
                'T2': [{ emoji: 'ğŸ±', name: 'ãƒã‚³' }, { emoji: 'ğŸŸ', name: 'ã•ã‹ãª' }],
                // Easy
                'A': [{ emoji: 'ğŸ', name: 'ãƒŸãƒ„ãƒãƒ' }, { emoji: 'ğŸŒ¸', name: 'ã‚µã‚¯ãƒ©' }],
                'B': [{ emoji: 'ğŸ¸', name: 'ã‚«ã‚¨ãƒ«' }, { emoji: 'ğŸ’§', name: 'ã¿ãšã¹' }],
                'C': [{ emoji: 'ğŸ¦‹', name: 'ã‚¢ã‚²ãƒãƒãƒ§ã‚¦' }, { emoji: 'ğŸŒ¿', name: 'ãƒŸã‚«ãƒ³ã® ã¯' }],
                'D': [{ emoji: 'ğŸ', name: 'ãƒ†ãƒ³ãƒˆã‚¦ãƒ ã‚·' }, { emoji: 'ğŸ¦ ', name: 'ã‚¢ãƒ–ãƒ©ãƒ ã‚·' }],
                'E': [{ emoji: 'ğŸ¦', name: 'ã¨ã‚Š' }, { emoji: 'ğŸ’', name: 'ãã® ã¿' }], // â˜… ã‚¢ã‚¤ã‚³ãƒ³å¤‰æ›´
                'F': [{ emoji: 'ğŸŸ', name: 'ãƒ¡ãƒ€ã‚«' }, { emoji: 'ğŸŒ¾', name: 'ãŸã‚“ã¼' }],
                // Medium
                'G': [{ emoji: 'ğŸ›', name: 'ã‚ˆã†ã¡ã‚…ã†' }, { emoji: 'ğŸ¦‹', name: 'ãƒãƒ§ã‚¦' }], // 'C' ã¨ã¯åˆ¥ãƒšã‚¢æ‰±ã„
                'H': [{ emoji: 'ğŸ„', name: 'ã‚­ãƒã‚³' }, { emoji: 'ğŸ‚', name: 'ãŠã¡ã°' }],
                'I': [{ emoji: 'ğŸŒ³', name: 'ã' }, { emoji: 'â˜€ï¸', name: 'ãŸã„ã‚ˆã†' }],
                'J': [{ emoji: 'ğŸ¦‡', name: 'ã‚³ã‚¦ãƒ¢ãƒª' }, { emoji: 'ğŸ¦Ÿ', name: 'ã‚«' }],
                'K': [{ emoji: 'ğŸŒ', name: 'ã‚«ã‚¿ãƒ„ãƒ ãƒª'}, { emoji: 'ğŸ¥¬', name: 'ã‚­ãƒ£ãƒ™ãƒ„'}],
                'L': [{ emoji: 'ğŸ¦€', name: 'ã‚«ãƒ‹'}, { emoji: 'ğŸŒŠ', name: 'ã†ã¿'}],
                'M': [{ emoji: 'ğŸ•¸ï¸', name: 'ã‚¯ãƒ¢ã®ã™'}, { emoji: 'ğŸª°', name: 'ãƒã‚¨'}],
                'N': [{ emoji: 'ğŸ¿ï¸', name: 'ãƒªã‚¹'}, { emoji: 'ğŸŒ°', name: 'ã©ã‚“ãã‚Š'}],
                // Hard (Mediumã®ãƒšã‚¢ + æ–°ã—ã„ãƒšã‚¢)
                'O': [{ emoji: 'ğŸ»', name: 'ã‚¯ãƒ'}, { emoji: 'ğŸ¯', name: 'ãƒãƒãƒŸãƒ„'}],
                'P': [{ emoji: 'ğŸ§', name: 'ãƒšãƒ³ã‚®ãƒ³'}, { emoji: 'ğŸ ', name: 'ã•ã‹ãª'}],
                'Q': [{ emoji: 'ğŸ’©', name: 'ãƒ•ãƒ³' }, { emoji: 'ğŸª²', name: 'ãƒ•ãƒ³ã‚³ãƒ­ã‚¬ã‚·' }],
                'R': [{ emoji: 'ğŸ‘¨â€ğŸŒ¾', name: 'ã²ã¨' }, { emoji: 'ğŸ…', name: 'ã‚„ã•ã„' }],
                'S': [{ emoji: 'ğŸŒ', name: 'ã¡ãã‚…ã†'}, { emoji: 'â™»ï¸', name: 'ãƒªã‚µã‚¤ã‚¯ãƒ«'}], // Hardå°‚ç”¨
                'T': [{ emoji: 'ğŸ­', name: 'ã“ã†ã˜ã‚‡ã†'}, { emoji: 'ğŸ’¨', name: 'ã‘ã‚€ã‚Š'}]  // Hardå°‚ç”¨
            };
            
            const explanations = {
                'T1': 'ğŸ¶ ã‚¤ãƒŒã¯ ğŸ¦´ ãƒ›ãƒãŒ ã ã„ã™ãï¼',
                'T2': 'ğŸ± ãƒã‚³ã¯ ğŸŸ ã•ã‹ãªã‚’ ãŸã¹ã‚‹ã®ãŒ ã™ãã ã­ã€‚',
                'A': 'ğŸ ãƒŸãƒ„ãƒãƒã¯ ğŸŒ¸ ã‚µã‚¯ãƒ©ã® ã¿ã¤ã‚’ ã‚‚ã‚‰ã† ã‹ã‚ã‚Šã«ã€ã‹ãµã‚“ã‚’ ã¯ã“ã‚“ã§ ã‚ã’ã‚‹ã‚“ã ã€‚',
                'B': 'ğŸ¸ ã‚«ã‚¨ãƒ«ã¯ ã“ã©ã‚‚ã® ã¨ã ğŸ’§ ã¿ãšã¹ï¼ˆã„ã‘ ã‚„ ãŸã‚“ã¼ï¼‰ã§ ã—ã‹ ã„ãã‚‰ã‚Œãªã„ã‚“ã ã€‚',
                'C': 'ğŸ¦‹ ã‚¢ã‚²ãƒãƒãƒ§ã‚¦ã® ã‚ˆã†ã¡ã‚…ã†ã¯ã€ğŸŒ¿ ãƒŸã‚«ãƒ³ã‚„ ã‚µãƒ³ã‚·ãƒ§ã‚¦ã® ãªã‹ã¾ã® ã¯ã£ã± ã—ã‹ ãŸã¹ãªã„ã‚ˆã€‚',
                'D': 'ğŸ ãƒ†ãƒ³ãƒˆã‚¦ãƒ ã‚·ã¯ã€ã—ã‚‡ãã¶ã¤ã® ã—ã‚‹ã‚’ ã™ã† ğŸ¦  ã‚¢ãƒ–ãƒ©ãƒ ã‚·ã‚’ ãŸã¹ã¦ ãã‚Œã‚‹ã‚“ã ã€‚',
                'E': 'ğŸ¦ ã¨ã‚Šã¯ ğŸ’ ãã® ã¿ã‚’ ãŸã¹ã¦ã€ãƒ•ãƒ³ã¨ ã„ã£ã—ã‚‡ã« ã¨ãŠãã¾ã§ ã‚¿ãƒã‚’ ã¯ã“ã¶ã‚“ã ã€‚', // â˜… ã‚¢ã‚¤ã‚³ãƒ³å¤‰æ›´
                'F': 'ğŸŸ ãƒ¡ãƒ€ã‚«ã¯ ğŸŒ¾ ãŸã‚“ã¼ ã®ã‚ˆã†ãªã€ãŠã ã‚„ã‹ãª ãªãŒã‚Œã® ã¿ãšãŒ ã ã„ã™ã ãªã‚“ã ã€‚',
                'G': 'ğŸ› ã‚ˆã†ã¡ã‚…ã†ã¯ã€ã•ãªã ã«ãªã£ã¦ ğŸ¦‹ ã™ã”ã„ ã‹ãŸã¡ã« ã¸ã‚“ã—ã‚“ï¼ˆã¸ã‚“ãŸã„ï¼‰ã™ã‚‹ã‚“ã ã€‚',
                'H': 'ğŸ„ ã‚­ãƒã‚³ã‚„ ğŸ‚ ãŠã¡ã°ã¯ã€ã¤ã¡ã® ãˆã„ã‚ˆã†ã« ãªã£ã¦ã€ã‚ãŸã‚‰ã—ã„ ã„ã®ã¡ã‚’ ãã ã¦ã‚‹ã‚ˆã€‚ï¼ˆã¶ã‚“ã‹ã„ã—ã‚ƒï¼‰',
                'I': 'ğŸŒ³ ãã¯ â˜€ï¸ ãŸã„ã‚ˆã†ã® ã²ã‹ã‚Šã‚’ ã‚ã³ã¦ã€ã˜ã¶ã‚“ã§ ãˆã„ã‚ˆã†ï¼ˆã•ã‚“ã ã‚‚ï¼‰ã‚’ ã¤ãã‚‹ã‚“ã ã€‚ï¼ˆã“ã†ã”ã†ã›ã„ï¼‰',
                'J': 'ğŸ¦‡ ã‚³ã‚¦ãƒ¢ãƒªã¯ã€ã‚ˆã‚‹ã« ğŸ¦Ÿ ã‚«ãªã©ã® ã‚€ã—ã‚’ ãŸãã•ã‚“ ãŸã¹ã¦ ãã‚Œã‚‹ã‚“ã ã‚ˆã€‚',
                'K': 'ğŸŒ ã‚«ã‚¿ãƒ„ãƒ ãƒªã¯ã€ã‚„ã‚ã‚‰ã‹ã„ ğŸ¥¬ ã‚­ãƒ£ãƒ™ãƒ„ã‚„ ã‚¢ã‚¸ã‚µã‚¤ã® ã¯ãŒ ã ã„ã™ãã€‚',
                'L': 'ğŸ¦€ ã‚«ãƒ‹ã¯ ğŸŒŠ ã†ã¿ ã‚„ ã‹ã‚ã® ã¿ãšã¹ã« ã™ã‚“ã§ã„ã‚‹ ãªã‹ã¾ãŒ ãŠãŠã„ã‚ˆã€‚',
                'M': 'ğŸ•¸ï¸ ã‚¯ãƒ¢ã¯ ã™ã‚’ ã¤ãã£ã¦ã€ã¤ã‹ã¾ãˆãŸ ğŸª° ãƒã‚¨ãªã©ã® ã‚€ã—ã‚’ ãŸã¹ã‚‹ã‚“ã ã€‚',
                'N': 'ğŸ¿ï¸ ãƒªã‚¹ã¯ ğŸŒ° ã©ã‚“ãã‚Šãªã©ã® ãã® ã¿ã‚’ ã‚ã¤ã‚ã¦ã€ãµã‚†ã« ããªãˆã‚‹ã‚“ã ã€‚',
                'O': 'ğŸ» ã‚¯ãƒã¯ ğŸ¯ ãƒãƒãƒŸãƒ„ãŒ ã ã„ã™ã ãªã‚“ã ã€‚ãƒãƒã« ã•ã•ã‚Œãªã„ã‚ˆã† ãã‚’ã¤ã‘ã¦ï¼',
                'P': 'ğŸ§ ãƒšãƒ³ã‚®ãƒ³ã¯ ã†ã¿ã® ãªã‹ã‚’ ãŠã‚ˆã„ã§ ğŸ  ã•ã‹ãªã‚’ ã¤ã‹ã¾ãˆã¦ ãŸã¹ã‚‹ã‚ˆã€‚',
                'Q': 'ğŸª² ãƒ•ãƒ³ã‚³ãƒ­ã‚¬ã‚·ã¯ ã©ã†ã¶ã¤ã® ğŸ’© ãƒ•ãƒ³ã‚’ ã¾ã‚‹ã‚ã¦ã€ã”ã¯ã‚“ ã«ã—ãŸã‚Š ã‚¿ãƒã‚´ã‚’ ã†ã‚“ã ã‚Š ã™ã‚‹ã‚“ã ã€‚',
                'R': 'ğŸ‘¨â€ğŸŒ¾ ã²ã¨ã¯ ğŸ… ã‚„ã•ã„ã‚„ ãŠã“ã‚ã‚’ ãã ã¦ã¦ ãŸã¹ã¦ã„ã‚‹ã­ã€‚ã“ã‚Œã‚‚ ã—ãœã‚“ã® ã¤ãªãŒã‚Šï¼',
                'S': 'ğŸŒ ã¡ãã‚…ã†ã® ã—ã’ã‚“ã‚’ ã¾ã‚‚ã‚‹ãŸã‚ã€ã¿ã‚“ãªã§ â™»ï¸ ãƒªã‚µã‚¤ã‚¯ãƒ« ã™ã‚‹ã®ã‚‚ ã ã„ã˜ãª ã¤ãªãŒã‚Šã€‚',
                'T': 'ğŸ­ ã“ã†ã˜ã‚‡ã† ã‚„ ãã‚‹ã¾ã® ğŸ’¨ ã‘ã‚€ã‚Š ãŒ ãµãˆã™ãã‚‹ã¨ã€ã„ãã‚‚ã®ãŒ ã™ã¿ã«ãã ãªã£ã¦ã—ã¾ã†ã‚“ã ã€‚',
            };

            const difficultyPairs = {
                tutorial: ['T1', 'T2'],
                easy: ['A', 'B', 'C', 'D', 'E', 'F'],
                medium: ['G', 'H', 'I', 'J', 'K', 'L', 'M', 'N'],
                hard: ['O', 'P', 'Q', 'R', 'S', 'T', 'C', 'D', 'H', 'I'] // Easy/Mediumã¨é‡è¤‡ã—ãªã„ã‚ˆã†ã«èª¿æ•´
            };

            // ã‚³ãƒã‚¯ãƒˆã‚²ãƒ¼ãƒ  çŠ¶æ…‹å¤‰æ•°
            let currentGameCards = [];
            let flippedCards = [];
            let matchedPairs = 0;
            let totalPairs = 0;
            let timerInterval = null;
            let secondsElapsed = 0;
            let isChecking = false;
            let currentDifficulty = 'easy';
            let usedExplanations = {};
            let consecutiveMistakes = 0; 

            // ã‚²ãƒ¼ãƒ åˆæœŸåŒ–
            function initConnectGame(difficulty) {
                currentDifficulty = difficulty;
                matchedPairs = 0;
                secondsElapsed = 0;
                flippedCards = [];
                isChecking = false;
                usedExplanations = {};
                consecutiveMistakes = 0;
                
                const gamePairIds = difficultyPairs[difficulty];
                totalPairs = gamePairIds.length;
                connectDoms.pairsLeftEl.textContent = totalPairs;
                
                currentGameCards = [];
                gamePairIds.forEach(id => {
                    if (allPairs[id] && explanations[id]) {
                        usedExplanations[id] = explanations[id];
                        const pair = allPairs[id];
                        currentGameCards.push({ pairId: id, emoji: pair[0].emoji, name: pair[0].name });
                        currentGameCards.push({ pairId: id, emoji: pair[1].emoji, name: pair[1].name });
                    }
                });

                currentGameCards = shuffleArray(currentGameCards);
                createConnectBoard();
                
                showScreen('connectGame');
                startConnectTimer();
                playBGM(); // â˜… BGMå†ç”Ÿ
            }

            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            function createConnectBoard() {
                connectDoms.gameBoard.innerHTML = '';
                connectDoms.gameBoard.className = `grid gap-2 sm:gap-4 grid-${currentDifficulty}`;
                
                currentGameCards.forEach((cardData, index) => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.dataset.id = index;
                    card.dataset.pairId = cardData.pairId;
                    
                    // ã‚«ãƒ¼ãƒ‰ã®çµµæ–‡å­—ã‚µã‚¤ã‚ºã‚’å‹•çš„ã«èª¿æ•´
                    let fontSize = '2.5rem';
                    if (cardData.emoji.length > 1) fontSize = '1.8rem';
                    if (window.innerWidth < 640) {
                        fontSize = cardData.emoji.length > 1 ? '1.5rem' : '2rem';
                    }

                    card.innerHTML = `
                        <div class="card-inner">
                            <div class="card-face card-back">ğŸŒ¿</div>
                            <div class="card-face card-front" style="font-size: ${fontSize};">
                                ${cardData.emoji}
                            </div>
                        </div>
                    `;
                    card.addEventListener('click', handleCardClick);
                    connectDoms.gameBoard.appendChild(card);
                });
            }

            function handleCardClick(event) {
                if (isChecking) return;
                const clickedCard = event.currentTarget;
                if (clickedCard.classList.contains('is-flipped') || clickedCard.classList.contains('is-matched')) {
                    return;
                }
                
                clickedCard.classList.add('is-flipped');
                flippedCards.push(clickedCard);
                
                if (flippedCards.length === 2) {
                    isChecking = true; // 2æšã‚ãã£ãŸã‚‰ãƒã‚§ãƒƒã‚¯é–‹å§‹
                    setTimeout(checkConnectMatch, 800); // 800ms å¾…ã£ã¦ã‹ã‚‰åˆ¤å®š
                }
            }

            // è§£èª¬ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            function showExplanationModal(text, callback) {
                stopConnectTimer(); // ã‚¿ã‚¤ãƒãƒ¼åœæ­¢
                explanationText.textContent = text;
                explanationModal.style.display = 'flex';
                
                // ã€Œã¤ãã¸ã€ãƒœã‚¿ãƒ³ã®ãƒªã‚¹ãƒŠãƒ¼
                explanationCloseBtn.onclick = () => {
                    explanationModal.style.display = 'none';
                    callback(); // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
                };
            }

            function checkConnectMatch() {
                const [card1, card2] = flippedCards;
                const pairId1 = card1.dataset.pairId;
                const pairId2 = card2.dataset.pairId;
                
                if (pairId1 === pairId2) {
                    // --- ãƒãƒƒãƒã—ãŸ ---
                    consecutiveMistakes = 0; // ãƒŸã‚¹ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆ
                    const explanation = explanations[pairId1] || 'ã™ã”ã„ã­ï¼';
                    
                    showExplanationModal(explanation, () => {
                        // ãƒãƒƒãƒå‡¦ç†ã®ç¶šã
                        flippedCards.forEach(card => card.classList.add('is-matched'));
                        matchedPairs++;
                        connectDoms.pairsLeftEl.textContent = totalPairs - matchedPairs;
                        
                        flippedCards = [];
                        isChecking = false;
                        
                        // ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ã‹ãƒã‚§ãƒƒã‚¯
                        if (matchedPairs === totalPairs) {
                            endConnectGame(true);
                        } else {
                            startConnectTimer(); // ã‚²ãƒ¼ãƒ ãŒç¶šããªã‚‰ã‚¿ã‚¤ãƒãƒ¼å†é–‹
                        }
                    });
                    
                } else {
                    // --- ãƒãƒƒãƒã—ãªã‹ã£ãŸ ---
                    consecutiveMistakes++;
                    // ç°¡æ˜“ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼ˆæ™‚é–“ã¯ 800msï¼‰
                    showSimpleModal('ã–ã‚“ã­ã‚“...', 'error'); 
                    
                    setTimeout(() => {
                        card1.classList.remove('is-flipped');
                        card2.classList.remove('is-flipped');
                        flippedCards = [];
                        isChecking = false;
                        
                        // ãƒ’ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯
                        if (consecutiveMistakes >= 5) {
                            showHint();
                            consecutiveMistakes = 0;
                        }
                    }, 800); // 800ms å¾…ã£ã¦ã‹ã‚‰
                }
            }
            
            // ãƒ’ãƒ³ãƒˆæ©Ÿèƒ½
            function showHint() {
                showSimpleModal('ãƒ’ãƒ³ãƒˆã ã‚ˆï¼', 'success', 1500);
                
                const remainingCards = document.querySelectorAll('#connect-game-board .card:not(.is-matched):not(.is-flipped)');
                if (remainingCards.length < 2) return;

                // ãƒ©ãƒ³ãƒ€ãƒ ã«1æšé¸ã¶
                const hintCard1 = remainingCards[Math.floor(Math.random() * remainingCards.length)];
                const hintPairId = hintCard1.dataset.pairId;
                let hintCard2 = null;

                // ãã®ãƒšã‚¢ã‚’æ¢ã™
                remainingCards.forEach(card => {
                    if (card !== hintCard1 && card.dataset.pairId === hintPairId) {
                        hintCard2 = card;
                    }
                });

                if (hintCard2) {
                    hintCard1.classList.add('is-hinting');
                    hintCard2.classList.add('is-hinting');
                    setTimeout(() => {
                        hintCard1.classList.remove('is-hinting');
                        hintCard2.classList.remove('is-hinting');
                    }, 1500); // 1.5ç§’ç‚¹æ»…
                }
            }

            function endConnectGame(isClear) {
                stopConnectTimer();
                
                if (isClear) {
                    // â˜… ãƒ©ãƒ³ã‚¯ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
                    const didRankIn = checkRanking(currentDifficulty, secondsElapsed);
                    
                    if (didRankIn) {
                        showRankingInputModal(currentDifficulty, secondsElapsed);
                    } else {
                        // ãƒ©ãƒ³ã‚¯ã‚¤ãƒ³ã—ãªã‹ã£ãŸå ´åˆã€é€šå¸¸ã®çµæœç”»é¢
                        showScreen('connectResult');
                        connectDoms.resultTitle.textContent = 'ã‚¯ãƒªã‚¢ï¼';
                        connectDoms.resultTitle.className = 'text-5xl font-extrabold text-yellow-500 mb-4';
                        connectDoms.resultTime.textContent = `ã‹ã‹ã£ãŸã˜ã‹ã‚“: ${secondsElapsed} ã³ã‚‡ã†`;
                        displayConnectExplanations();
                    }
                }
            }

            // â˜… ãƒ©ãƒ³ã‚¯ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯é–¢æ•°
            function checkRanking(difficulty, time) {
                if (difficulty === 'tutorial') {
                    return false; // ãŠãŸã‚ã—ã¯ç™»éŒ²ã—ãªã„
                }
                const rank = getRanking(difficulty);
                if (rank.length < 10) {
                    return true; // 10äººæœªæº€ãªã‚‰ãƒ©ãƒ³ã‚¯ã‚¤ãƒ³
                }
                // 10ä½ã®ã‚¿ã‚¤ãƒ ã‚ˆã‚Šæ—©ã‘ã‚Œã°ãƒ©ãƒ³ã‚¯ã‚¤ãƒ³
                return time < rank[rank.length - 1].time;
            }

            // â˜… ãƒ©ãƒ³ã‚¯ã‚¤ãƒ³å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            function showRankingInputModal(difficulty, time) {
                rankingModalTime.textContent = `ã‚¿ã‚¤ãƒ : ${time} ã³ã‚‡ã†`;
                playerNameInput.value = ''; // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
                rankingModalOverlay.style.display = 'flex';

                // ç™»éŒ²ãƒœã‚¿ãƒ³ã®ãƒªã‚¹ãƒŠãƒ¼ï¼ˆä¸€åº¦ã ã‘è¨­å®šï¼‰
                rankingSubmitBtn.onclick = () => {
                    let name = playerNameInput.value.trim();
                    if (name === '') {
                        name = 'ãªãªã—ã•ã‚“';
                    }
                    name = name.slice(0, 8); // 8æ–‡å­—ã«åˆ¶é™
                    
                    saveRanking(difficulty, name, time);
                    
                    rankingModalOverlay.style.display = 'none';
                    
                    // çµæœç”»é¢ã‚’è¡¨ç¤º
                    showScreen('connectResult');
                    connectDoms.resultTitle.textContent = 'ã‚¯ãƒªã‚¢ï¼';
                    connectDoms.resultTime.textContent = `ã‹ã‹ã£ãŸã˜ã‹ã‚“: ${secondsElapsed} ã³ã‚‡ã† (ã¨ã†ã‚ãã—ãŸã‚ˆï¼)`;
                    displayConnectExplanations();

                    // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’æ›´æ–°
                    displayRanking();
                };
            }

            function displayConnectExplanations() {
                connectDoms.explanationArea.innerHTML = '';
                Object.values(usedExplanations).forEach(text => {
                    const p = document.createElement('p');
                    p.textContent = text;
                    connectDoms.explanationArea.appendChild(p);
                });
            }

            // ã‚¿ã‚¤ãƒãƒ¼
            function startConnectTimer() {
                stopConnectTimer(); // å¿µã®ãŸã‚ãƒªã‚»ãƒƒãƒˆ
                timerInterval = setInterval(() => {
                    secondsElapsed++;
                    connectDoms.timerEl.textContent = secondsElapsed;
                }, 1000);
            }

            function stopConnectTimer() {
                clearInterval(timerInterval);
            }

            // ã‚³ãƒã‚¯ãƒˆã‚²ãƒ¼ãƒ  ãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            connectDoms.difficultyButtons.forEach(button => {
                button.addEventListener('click', () => {
                    initConnectGame(button.dataset.difficulty);
                });
            });
            connectDoms.restartButton.addEventListener('click', () => {
                // â˜… ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã«æˆ»ã‚‹å‰ã«ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’å†è¡¨ç¤º
                displayRanking();
                showScreen('connectStart');
                pauseBGM(); // â˜… BGMåœæ­¢ (ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã«æˆ»ã‚‹ãŸã‚)
            });
            // â˜… ãŠã‚ã‚‹ãƒœã‚¿ãƒ³ ãƒªã‚¹ãƒŠãƒ¼
            connectDoms.quitButton.addEventListener('click', () => {
                stopConnectTimer(); // ã‚²ãƒ¼ãƒ ã‚’ä¸€æ™‚åœæ­¢
                pauseBGM(); // â˜… BGMä¸€æ™‚åœæ­¢
                confirmModalOverlay.style.display = 'flex';
            });


            // --- 2. ã„ãã‚‚ã® ã•ãŒã— (ã‹ãã‚Œã‚“ã¼) ---
            
            // ã•ãŒã—ã‚²ãƒ¼ãƒ  DOM
            const findDoms = {
                targetList: document.getElementById('find-game-targets'),
                gameArea: document.getElementById('find-game-area'),
                svgCanvas: document.getElementById('find-game-svg'),
                resultTitle: document.getElementById('find-result-title'),
                resultMsg: document.getElementById('find-result-message'),
                explanationArea: document.getElementById('find-explanation-area'),
                restartBtn: document.getElementById('find-restart-button'),
                backBtn: document.getElementById('find-back-button'),
                quitButton: document.getElementById('find-quit-game'), // â˜… è¿½åŠ 
            };

            const SVG_NS = "http://www.w3.org/2000/svg";

            // ã•ãŒã—ã‚²ãƒ¼ãƒ  ãƒ‡ãƒ¼ã‚¿ (ä¿è­·è‰²ãƒ†ãƒ¼ãƒ)
            const findGameData = [
                { 
                    id: 'A', name: 'ãƒŠãƒŠãƒ•ã‚·', hint: 'ã»ããªãŒã„ ãˆã ï¼Ÿ', 
                    explanation: 'ã›ã„ã‹ã„ï¼ã“ã‚Œã¯ ãƒŠãƒŠãƒ•ã‚· ã ã‚ˆã€‚ã»ãã„ ãˆã  ã« ãã£ãã‚Šã§ã€ã¦ã ã‹ã‚‰ ã¿ã¤ã‹ã‚Šã«ãã„ã‚“ã ã€‚',
                    draw: (svg) => {
                        const el = document.createElementNS(SVG_NS, 'line');
                        el.setAttribute('x1', '120'); el.setAttribute('y1', '110');
                        el.setAttribute('x2', '180'); el.setAttribute('y2', '125');
                        el.setAttribute('stroke', '#755C48'); // èƒŒæ™¯ã®æœ¨(#8B4513)ã‚ˆã‚Šå°‘ã—æ˜ã‚‹ã„
                        el.setAttribute('stroke-width', '4');
                        return el;
                    }
                },
                { 
                    id: 'B', name: 'ã‚«ã‚¨ãƒ«', hint: 'ãã• ã¨ ãŠãªã˜ ã„ã‚',
                    explanation: 'ã¿ã¤ã‘ãŸï¼ ã‚¢ãƒã‚¬ã‚¨ãƒ« ã ã­ã€‚ãã•ã‚€ã‚‰ ã¨ ãŠãªã˜ ã¿ã©ã‚Šã„ã‚ ã§ ã‹ãã‚Œã¦ã„ã‚‹ã‚“ã ã€‚',
                    draw: (svg) => {
                        const el = document.createElementNS(SVG_NS, 'circle');
                        el.setAttribute('cx', '50'); el.setAttribute('cy', '270');
                        el.setAttribute('r', '7');
                        el.setAttribute('fill', '#34A153'); // èƒŒæ™¯ã®è‰(#2E8B57)ã‚ˆã‚Šå°‘ã—æ˜ã‚‹ã„
                        return el;
                    }
                },
                {
                    id: 'C', name: 'ã‚³ãƒãƒãƒãƒ§ã‚¦', hint: 'ã‹ã‚ŒãŸ ã¯ã£ã±ï¼Ÿ',
                    explanation: 'ã™ã”ã„ï¼ ã‚³ãƒãƒãƒãƒ§ã‚¦ ã ï¼ã¯ã­ã‚’ ã¨ã˜ã‚‹ã¨ã€ã‹ã‚ŒãŸ ã¯ã£ã± ã« ãã£ãã‚Šã ã­ã€‚',
                    draw: (svg) => {
                        const el = document.createElementNS(SVG_NS, 'path');
                        el.setAttribute('d', 'M330 230 L350 250 L335 260 L330 230 Z');
                        el.setAttribute('fill', '#A0522D'); // èŒ¶è‰²
                        return el;
                    }
                },
                {
                    id: 'D', name: 'ãƒãƒƒã‚¿', hint: 'ã¿ã©ã‚Š ã® ãã•ã°ã­',
                    explanation: 'ã‚„ã£ãŸã­ï¼ ãƒãƒƒã‚¿ ã ï¼ã¿ã©ã‚Šã„ã‚ã® ã‹ã‚‰ã ã¯ã€ãã•ã‚€ã‚‰ ã« ã¾ãã‚Œã‚‹ã®ã« ã´ã£ãŸã‚Šï¼',
                    draw: (svg) => {
                        const el = document.createElementNS(SVG_NS, 'ellipse');
                        el.setAttribute('cx', '250'); el.setAttribute('cy', '280');
                        el.setAttribute('rx', '10'); el.setAttribute('ry', '3');
                        el.setAttribute('fill', '#559E2B'); // èƒŒæ™¯ã®è‰(#228B22)ã‚ˆã‚Šæ˜ã‚‹ã„
                        el.setAttribute('transform', 'rotate(-30 250 280)');
                        return el;
                    }
                },
                {
                    id: 'E', name: 'ãƒ¢ãƒ³ã‚·ãƒ­ãƒãƒ§ã‚¦', hint: 'ã—ã‚ã„ ã¯ãªï¼Ÿ',
                    explanation: 'ã›ã„ã‹ã„ï¼ ãƒ¢ãƒ³ã‚·ãƒ­ãƒãƒ§ã‚¦ ã ã‚ˆã€‚ã—ã‚ã„ ã¯ãª ã® ã¡ã‹ã ã«ã„ã‚‹ã¨ ã¿ã¤ã‹ã‚Šã«ãã„ã­ã€‚',
                    draw: (svg) => {
                        const el = document.createElementNS(SVG_NS, 'path');
                        el.setAttribute('d', 'M150 50 Q 155 45 160 50 L 155 55 Z M 155 55 L 160 60 Q 155 65 150 60 Z');
                        el.setAttribute('fill', '#F0F0F0'); // ç™½
                        return el;
                    }
                },
            ];
            
            // SVGèƒŒæ™¯ (ã‚ˆã‚Šè¤‡é›‘ã«)
            const findGameBG = `
                <!-- ãã‚‰ -->
                <rect width="400" height="200" fill="#87CEEB"></rect>
                <!-- ãŸã„ã‚ˆã† -->
                <circle cx="350" cy="50" r="30" fill="#FFD700"></circle>
                <!-- ãã‚‚ -->
                <circle cx="150" cy="50" r="15" fill="#FFFFFF"></circle>
                <circle cx="165" cy="50" r="15" fill="#FFFFFF"></circle>
                <circle cx="158" cy="40" r="15" fill="#FFFFFF"></circle>
                <!-- ã˜ã‚ã‚“ï¼ˆãŠãï¼‰ -->
                <rect y="190" width="400" height="110" fill="#228B22"></rect>
                <!-- ã˜ã‚ã‚“ï¼ˆã¦ã¾ãˆï¼‰ -->
                <path d="M 0 300 C 50 280, 150 280, 200 290 S 300 310, 400 290 V 300 H 0 Z" fill="#2E8B57" />
                <!-- ãï¼ˆã¿ãï¼‰ -->
                <rect x="100" y="100" width="30" height="100" fill="#8B4513"></rect>
                <!-- ãï¼ˆã¯ã£ã±ï¼‰ -->
                <circle cx="115" cy="80" r="40" fill="#006400"></circle>
                <circle cx="95" cy="100" r="35" fill="#006400"></circle>
                <circle cx="135" cy="100" r="35" fill="#006400"></circle>
                <!-- ãã•ã‚€ã‚‰ -->
                <circle cx="40" cy="275" r="20" fill="#2E8B57"></circle>
                <circle cx="60" cy="280" r="25" fill="#2E8B57"></circle>
                <circle cx="240" cy="285" r="30" fill="#228B22"></circle>
                <circle cx="260" cy="280" r="25" fill="#228B22"></circle>
                <!-- ã‹ã‚Œã¯ï¼ˆãŠã¡ã°ï¼‰ -->
                <path d="M320 240 L340 260 L325 270 L320 240 Z" fill="#A0522D" opacity="0.5"></path>
            `;

            // ã•ãŒã—ã‚²ãƒ¼ãƒ  çŠ¶æ…‹å¤‰æ•°
            let findGameTargets = [];
            let foundTargetsCount = 0;
            let findGameExplanations = {};

            function initFindGame() {
                findGameTargets = shuffleArray([...findGameData]);
                foundTargetsCount = 0;
                findGameExplanations = {}; // è§£èª¬ãƒªã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
                
                updateTargetList();
                placeAnimals();
                showScreen('findGame');
                playBGM(); // â˜… BGMå†ç”Ÿ
            }
            
            // æ¢ã™ãƒªã‚¹ãƒˆã‚’UIã«è¡¨ç¤º
            function updateTargetList(foundId = null) {
                if (foundId === null) {
                    // ãŠã‚ã‚‹ãƒœã‚¿ãƒ³ãŒã‚ã‚‹ã®ã§ã€innerHTMLã®å…¨æ¶ˆã—ã¯ã—ãªã„
                    // æ—¢å­˜ã® .target-item ã‚’å‰Šé™¤
                    findDoms.targetList.querySelectorAll('.target-item').forEach(item => item.remove());
                    
                    findGameTargets.forEach(target => {
                        const item = document.createElement('span');
                        item.id = `target-item-${target.id}`;
                        item.className = 'target-item';
                        item.textContent = `â“ ${target.hint}`; // ãƒ’ãƒ³ãƒˆã‚’è¡¨ç¤º
                        findDoms.targetList.appendChild(item);
                    });
                } else {
                    const item = document.getElementById(`target-item-${foundId}`);
                    const target = findGameTargets.find(t => t.id === foundId);
                    if (item && target) {
                        item.classList.add('is-found');
                        item.textContent = `â­• ${target.name}`; // è¦‹ã¤ã‘ãŸã‚‰åå‰ã«å¤‰æ›´
                    }
                }
            }
            
            // å‹•ç‰©ã‚’é…ç½®
            function placeAnimals() {
                findDoms.svgCanvas.innerHTML = findGameBG; // èƒŒæ™¯ã‚’ãƒªã‚»ãƒƒãƒˆ
                
                findGameTargets.forEach(animal => {
                    const el = animal.draw(findDoms.svgCanvas); // æç”»é–¢æ•°ã‚’å‘¼ã³å‡ºã—
                    el.classList.add('target-animal');
                    el.dataset.targetId = animal.id;
                    
                    el.addEventListener('click', handleTargetClick);
                    findDoms.svgCanvas.appendChild(el);
                });
            }
            
            // å‹•ç‰©ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
            function handleTargetClick(e) {
                e.stopPropagation(); // SVGã®è¦ªã¸ã®ã‚¤ãƒ™ãƒ³ãƒˆä¼æ’­ã‚’åœæ­¢
                const clickedEl = e.currentTarget;
                if (clickedEl.classList.contains('is-found')) return;
                
                const id = clickedEl.dataset.targetId;
                const target = findGameTargets.find(t => t.id === id);
                if (!target) return;

                // è§£èª¬ã‚’ä¿å­˜
                findGameExplanations[id] = target.explanation;

                // è§£èª¬ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                showExplanationModal(target.explanation, () => {
                    clickedEl.classList.add('is-found');
                    foundTargetsCount++;
                    updateTargetList(id); // UIã®ãƒªã‚¹ãƒˆã«ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯
                    
                    if (foundTargetsCount === findGameTargets.length) {
                        setTimeout(() => {
                            endFindGame();
                        }, 500); // å°‘ã—å¾…ã£ã¦ã‹ã‚‰çµæœç”»é¢ã¸
                    }
                });
            }

            // ã•ãŒã—ã‚²ãƒ¼ãƒ çµ‚äº†å‡¦ç†
            function endFindGame() {
                showScreen('findResult');
                // è§£èª¬ä¸€è¦§ã‚’è¡¨ç¤º
                findDoms.explanationArea.innerHTML = '';
                findGameTargets.forEach(target => {
                    const p = document.createElement('p');

                    // XSSå¯¾ç­– (ç°¡æ˜“)
                    const safeExplanation = document.createTextNode(findGameExplanations[target.id] || 'ã¿ã¤ã‘ãŸã­ï¼').textContent;
                    p.textContent = safeExplanation;
                    findDoms.explanationArea.appendChild(p);
                });
            }
            
            // ã•ãŒã—ã‚²ãƒ¼ãƒ  ãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            findDoms.restartBtn.addEventListener('click', initFindGame);
            findDoms.backBtn.addEventListener('click', () => {
                showScreen('gameSelect');
                pauseBGM(); // â˜… BGMåœæ­¢
            });
            // â˜… ãŠã‚ã‚‹ãƒœã‚¿ãƒ³ ãƒªã‚¹ãƒŠãƒ¼
            findDoms.quitButton.addEventListener('click', () => {
                pauseBGM(); // â˜… BGMä¸€æ™‚åœæ­¢
                confirmModalOverlay.style.display = 'flex';
            });

            // --- â˜… å…±é€š ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« ãƒªã‚¹ãƒŠãƒ¼ ---
            confirmCancelBtn.addEventListener('click', () => {
                confirmModalOverlay.style.display = 'none';
                // ã‚³ãƒã‚¯ãƒˆã‚²ãƒ¼ãƒ ä¸­ãªã‚‰ã‚¿ã‚¤ãƒãƒ¼å†é–‹
                if (screens.connectGame.classList.contains('active')) {
                    startConnectTimer(); 
                    playBGM(); // â˜… BGMå†é–‹
                } else if (screens.findGame.classList.contains('active')) {
                    playBGM(); // â˜… BGMå†é–‹
                }
            });

            confirmOkBtn.addEventListener('click', () => {
                confirmModalOverlay.style.display = 'none';
                stopConnectTimer(); // å¿µã®ãŸã‚ã‚¿ã‚¤ãƒãƒ¼åœæ­¢
                pauseBGM(); // â˜… BGMåœæ­¢ (OKãƒœã‚¿ãƒ³ãªã®ã§)
                
                // ç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªç”»é¢ã«å¿œã˜ã¦æˆ»ã‚‹
                if (screens.connectGame.classList.contains('active')) {
                    displayRanking();
                    showScreen('connectStart');
                } else if (screens.findGame.classList.contains('active')) {
                    showScreen('gameSelect'); // ã•ãŒã—ã‚²ãƒ¼ãƒ ã¯ã‚²ãƒ¼ãƒ é¸æŠç”»é¢ã¸
                }
            });

            // --- â˜… ãƒŸãƒ¥ãƒ¼ãƒˆãƒœã‚¿ãƒ³ ãƒªã‚¹ãƒŠãƒ¼ (bgMusic ã‚’ bgm ã«ä¿®æ­£) ---
            muteToggleBtn.addEventListener('click', () => {
                bgm.muted = !bgm.muted;
                if (bgm.muted) {
                    muteToggleBtn.textContent = 'ãŠã¨ ã ã™ğŸ”ˆ';
                    bgm.pause(); // ãƒŸãƒ¥ãƒ¼ãƒˆã—ãŸã‚‰åœæ­¢
                } else {
                    muteToggleBtn.textContent = 'ãŠã¨ ã‘ã™ğŸ”‡';
                    // ã‚²ãƒ¼ãƒ ä¸­ãªã‚‰å†ç”Ÿ
                    if (screens.connectGame.classList.contains('active') || screens.findGame.classList.contains('active')) {
                         bgm.play().catch(e => console.log("BGMå†ç”Ÿã‚¨ãƒ©ãƒ¼: ", e));
                    }
                }
            });

            // --- åˆæœŸåŒ– ---
            displayRanking(); // èµ·å‹•æ™‚ã«å…¨ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡¨ç¤º

        });
    </script>
</body>
</html>



