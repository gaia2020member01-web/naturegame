<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>いきものコネクト＆さがし</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=M+PLUS+Rounded+1c:wght@700;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'M PLUS Rounded 1c', 'Inter', sans-serif;
            touch-action: manipulation; /* ダブルタップズームを無効化 */
        }

        /* --- 共通スタイル --- */
        .screen {
            display: none;
            width: 100%;
            min-height: 100vh;
            padding: 20px;
        }
        .screen.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .game-title {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
        }
        @media (min-width: 640px) {
            .game-title { font-size: 3.5rem; }
        }
        .game-subtitle {
            font-size: 1.1rem;
            color: #4b5563; /* gray-600 */
            margin-bottom: 2rem;
        }
        @media (min-width: 640px) {
            .game-subtitle { font-size: 1.25rem; }
        }
        .game-button {
            width: 100%;
            color: white;
            font-weight: 700;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem; /* 12px */
            font-size: 1.25rem; /* 20px */
            transition: all 0.2s;
            transform: scale(1);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .game-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        /* --- ランキング表示 (3カラム) --- */
        #ranking-section .rank-column h4 {
            font-size: 1.1rem; /* かんたん/ふつう/むずかしい の文字サイズ */
            font-weight: 700;
            text-align: center;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 3px solid;
        }
        #ranking-section ol {
            list-style-type: decimal;
            list-style-position: inside;
            text-align: left;
            height: 12rem; /* 192px */
            overflow-y: auto;
            background-color: #f9fafb; /* gray-50 */
            padding: 0.75rem; /* 12px */
            border-radius: 0.5rem; /* 8px */
            border: 1px solid #e5e7eb; /* gray-200 */
        }
        #ranking-section li {
            font-size: 0.9rem; /* ランキングの文字サイズ */
            padding: 0.1rem 0.25rem;
            border-radius: 4px;
        }
        @media (min-width: 640px) {
             #ranking-section li {
                font-size: 1rem; /* 16px */
             }
        }
        #ranking-section li:nth-child(odd) {
            background-color: #ffffff; /* white */
        }
        #ranking-section li .rank-name {
            font-weight: 700;
            color: #1f2937; /* gray-800 */
            display: inline-block;
            max-width: 60%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            vertical-align: bottom;
        }
        #ranking-section li .rank-time {
            float: right;
            font-weight: 700;
            color: #1d4ed8; /* blue-700 */
        }
        /* 1位 */
        #ranking-section li:nth-child(1) { 
            background-color: #fef9c3; /* yellow-100 */
        }
        #ranking-section li:nth-child(1) .rank-name {
            color: #ca8a04; /* yellow-600 */
        }

        /* --- コネクトゲーム（神経衰弱）スタイル --- */
        .card {
            width: 100%;
            aspect-ratio: 1 / 1;
            perspective: 1000px;
            cursor: pointer;
        }
        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .card.is-flipped .card-inner {
            transform: rotateY(180deg);
        }
        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .card-back {
            background-color: #4ade80; /* green-400 */
            color: white;
            font-size: 3rem;
        }
        .card-front {
            background-color: #f0fdf4; /* green-50 */
            color: #166534; /* green-800 */
            font-size: 2.5rem;
            transform: rotateY(180deg);
            padding: 8px;
            line-height: 1;
        }
        .card.is-matched {
            opacity: 0.3;
            pointer-events: none;
        }
        /* ヒント用アニメーション */
        .card.is-hinting .card-back {
            animation: hint-blink 0.5s 3;
        }
        @keyframes hint-blink {
            50% {
                transform: scale(1.1);
                background-color: #fde047; /* yellow-400 */
            }
        }

        /* グリッド */
        .grid-tutorial { grid-template-columns: repeat(2, 1fr); max-width: 200px; }
        .grid-easy { grid-template-columns: repeat(4, 1fr); }
        .grid-medium { grid-template-columns: repeat(4, 1fr); }
        .grid-hard { grid-template-columns: repeat(5, 1fr); }
        @media (max-width: 640px) {
            .card-back { font-size: 2rem; }
            .card-front { font-size: 1.8rem; }
            .grid-tutorial { max-width: 150px; }
            .grid-easy { grid-template-columns: repeat(3, 1fr); }
            .grid-medium { grid-template-columns: repeat(4, 1fr); }
            .grid-hard { grid-template-columns: repeat(4, 1fr); }
        }

        /* --- モーダル共通 --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; /* JSで制御 */
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 20px;
        }
        /* 簡易モーダル（せいかい/ざんねん） */
        #simple-modal-content {
            padding: 30px 40px;
            border-radius: 16px;
            color: white;
            font-size: 2.5rem;
            font-weight: 800;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.4);
        }
        #simple-modal-content.success {
            background: linear-gradient(135deg, #68d391, #38a169); /* green */
        }
        #simple-modal-content.error {
            background: linear-gradient(135deg, #fc8181, #e53e3e); /* red */
        }
        /* 解説モーダル */
        #explanation-modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        #explanation-text {
            font-size: 1.25rem;
            color: #1f2937;
            margin-bottom: 24px;
            line-height: 1.6;
        }
        /* ランクイン入力モーダル */
        #ranking-modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        /* ★ 確認モーダル */
        #confirm-modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 100%;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        /* ★ エラー入力 (シェイク) */
        @keyframes shake {
          0%, 100% { transform: translateX(0); }
          10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
          20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .is-invalid {
            animation: shake 0.5s ease-in-out;
            border: 2px solid #e53e3e; /* red-600 */
        }


        /* --- いきものさがしゲーム スタイル --- */
        #find-game-area {
            width: 100%;
            max-width: 800px;
            height: 65vh;
            border-radius: 12px;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
            border: 4px solid #86efac; /* green-300 */
        }
        #find-game-svg {
            width: 100%;
            height: 100%;
        }
        .target-animal {
            cursor: pointer;
            transition: opacity 0.3s ease, transform 0.2s ease;
            opacity: 0.9; /* 少しだけ透明にして探しにくく */
        }
        .target-animal:hover {
            opacity: 1;
            transform: scale(1.2);
            stroke: #fef08a; /* yellow-200 */
            stroke-width: 2px;
        }
        .target-animal.is-found {
            opacity: 0.3;
            pointer-events: none;
        }
        #find-game-targets {
            display: flex;
            flex-direction: column; /* 縦並びに変更 */
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 20px;
            padding: 12px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            max-width: 800px;
            width: 100%;
            position: relative; /* ★ おわるボタン配置のため */
        }
        .target-item {
            font-size: 1.1rem;
            font-weight: 700;
            color: #6b7280; /* gray-500 */
            transition: all 0.3s;
        }
        .target-item.is-found {
            color: #10b981; /* green-500 */
            text-decoration: line-through;
        }
        /* 解説エリアの共通スタイル */
        .explanation-list {
            text-align: left;
            background: #f9fafb; /* gray-50 */
            padding: 1rem 1.5rem;
            border-radius: 0.5rem; /* 8px */
            max-height: 16rem; /* 256px */
            overflow-y: auto;
            margin-bottom: 2rem;
            border: 1px solid #e5e7eb; /* gray-200 */
        }
        .explanation-list h3 {
            font-size: 1.5rem; /* 24px */
            font-weight: 700;
            color: #166534; /* green-800 */
            margin-bottom: 1rem;
        }
        .explanation-list div {
            font-size: 1.1rem; /* 18px */
        }

        /* --- ★ 設定画面 --- */
        #settings-screen .setting-item {
            width: 100%;
            max-width: 400px;
            margin-bottom: 1.5rem; /* 24px */
        }
        #settings-screen label {
            display: block;
            font-size: 1.1rem; /* 18px */
            font-weight: 700;
            margin-bottom: 0.5rem; /* 8px */
            color: #374151; /* gray-700 */
        }
        #settings-screen input[type="range"] {
            width: 100%;
            cursor: pointer;
        }
        #settings-screen select {
            width: 100%;
            padding: 0.75rem; /* 12px */
            font-size: 1.1rem; /* 18px */
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.5rem; /* 8px */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div id="app">

        <!-- 0. ゲーム選択画面 -->
        <div id="game-select-screen" class="screen active">
            <div class="text-center p-6 bg-white rounded-2xl shadow-xl max-w-lg w-full">
                <h1 class="game-title text-green-700">いきもの ワールド</h1>
                <p class="game-subtitle">どちらのゲームであそぶ？</p>
                
                <div class="space-y-4">
                    <button id="select-connect-game" class="game-button bg-blue-500 hover:bg-blue-600">
                        🤝 いきものコネクト！
                    </button>
                    <button id="select-find-game" class="game-button bg-yellow-500 hover:bg-yellow-600">
                        👀 いきもの かくれんぼ
                    </button>
                    <!-- ★ 設定ボタン -->
                    <button id="settings-button" class="game-button bg-gray-500 hover:bg-gray-600">
                        ⚙️ せってい
                    </button>
                </div>
            </div>
        </div>

        <!-- ★ 設定画面 (新規追加) -->
        <div id="settings-screen" class="screen">
            <div class="text-center p-6 bg-white rounded-2xl shadow-xl max-w-lg w-full">
                <h1 class="game-title text-gray-700">⚙️ せってい</h1>
                
                <!-- 音量 -->
                <div class="setting-item">
                    <label for="volume-slider">おんりょう (BGM)</label>
                    <div class="flex items-center space-x-2">
                        <span class="text-xl">🔈</span>
                        <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="0.5">
                        <span class="text-xl">🔊</span>
                    </div>
                </div>

                <!-- BGM選択 -->
                <div class="setting-item">
                    <label for="bgm-select">BGM を えらぶ</label>
                    <select id="bgm-select">
                        <option value="music.mp3">ミュージック 1</option>
                        <option value="music2.mp3">ミュージック 2</option>
                        <option value="music3.mp3">ミュージック 3</option> <!-- ★ 追加 -->
                    </select>
                </div>

                <!-- ランキングリセット -->
                <div class="setting-item mt-8">
                    <label>ランキングリセット</label>
                    <button id="reset-ranking-btn" class="game-button bg-red-600 hover:bg-red-700">
                        ランキングを ぜんぶ けす
                    </button>
                </div>

                <!-- 戻るボタン -->
                <button id="settings-back-button" class="game-button bg-gray-400 hover:bg-gray-500 mt-12">
                    もどる
                </button>
            </div>
        </div>

        <!-- 1. コネクトゲーム スタート画面 -->
        <div id="connect-start-screen" class="screen">
            <div class="text-center p-6 bg-white rounded-2xl shadow-xl max-w-3xl w-full">
                <h1 class="game-title text-blue-600">いきものコネクト！</h1>
                <p class="game-subtitle">みぢかな なかまを みつけよう</p>

                <!-- ★★★ 3カラム ランキング表示エリア ★★★ -->
                <div id="ranking-section" class="w-full mb-6">
                    <h3 class="text-2xl font-bold text-gray-700 mb-4">🏆 ランキング 🏆</h3>
                    <div class="flex flex-col sm:flex-row justify-between space-y-4 sm:space-y-0 sm:space-x-4">
                        
                        <!-- かんたん -->
                        <div class="flex-1 rank-column">
                            <h4 class="text-blue-600 border-blue-500">-- かんたん --</h4>
                            <ol id="ranking-list-easy">
                                <!-- JSで挿入 -->
                            </ol>
                        </div>
                        
                        <!-- ふつう -->
                        <div class="flex-1 rank-column">
                            <h4 class="text-yellow-600 border-yellow-500">-- ふつう --</h4>
                            <ol id="ranking-list-medium">
                                <!-- JSで挿入 -->
                            </ol>
                        </div>
                        
                        <!-- むずかしい -->
                        <div class="flex-1 rank-column">
                            <h4 class="text-red-600 border-red-500">-- むずかしい --</h4>
                            <ol id="ranking-list-hard">
                                <!-- JSで挿入 -->
                            </ol>
                        </div>

                    </div>
                </div>
                <!-- ★★★ ここまで ★★★ -->
                
                <div class="space-y-4">
                    <button data-difficulty="tutorial" class="difficulty-btn game-button bg-green-500 hover:bg-green-600">
                        おためし (2ペア)
                    </button>
                    <button data-difficulty="easy" class="difficulty-btn game-button bg-blue-500 hover:bg-blue-600">
                        かんたん (6ペア)
                    </button>
                    <button data-difficulty="medium" class="difficulty-btn game-button bg-yellow-500 hover:bg-yellow-600">
                        ふつう (8ペア)
                    </button>
                    <button data-difficulty="hard" class="difficulty-btn game-button bg-red-500 hover:bg-red-600">
                        むずかしい (10ペア)
                    </button>
                    <button id="connect-back-button" class="game-button bg-gray-400 hover:bg-gray-500 mt-6">
                        もどる
                    </button>
                </div>
            </div>
        </div>

        <!-- 2. コネクトゲーム ゲーム画面 -->
        <div id="connect-game-screen" class="screen">
            <div class="w-full max-w-3xl mx-auto">
                <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-md mb-6">
                    <div>
                        <span class="text-lg font-bold text-gray-600">のこりペア:</span>
                        <span id="pairs-left" class="text-2xl font-extrabold text-blue-700">0</span>
                    </div>
                    <div>
                        <span class="text-lg font-bold text-gray-600">じかん:</span>
                        <span id="timer" class="text-2xl font-extrabold text-red-600">0</span>
                    </div>
                    <!-- ★ おわるボタン追加 -->
                    <button id="connect-quit-game" class="text-sm font-bold bg-gray-200 text-gray-600 px-3 py-2 rounded-lg hover:bg-gray-300">
                        おわる
                    </button>
                </div>

                <div id="connect-game-board" class="grid gap-2 sm:gap-4">
                    <!-- カードはJSで生成されます -->
                </div>
            </div>
        </div>

        <!-- 3. コネクトゲーム 結果・解説画面 -->
        <div id="connect-result-screen" class="screen">
            <div class="text-center p-6 sm:p-10 bg-white rounded-2xl shadow-xl max-w-2xl w-full">
                <h2 id="connect-result-title" class="text-5xl font-extrabold text-yellow-500 mb-4">クリア！</h2>
                <p id="connect-result-time" class="text-2xl text-gray-700 mb-8">かかったじかん: 60びょう</p>
                
                <div class="explanation-list">
                    <h3>みつけた「つながり」いちらん</h3>
                    <div id="connect-explanation-area" class="space-y-4">
                        <!-- 解説はJSで生成されます -->
                    </div>
                </div>

                <button id="connect-restart-button" class="game-button bg-green-500 hover:bg-green-600">
                    もういちど あそぶ
                </button>
            </div>
        </div>

        <!-- 4. さがしゲーム ゲーム画面 -->
        <div id="find-game-screen" class="screen">
            <div class="w-full max-w-3xl mx-auto flex flex-col items-center">
                <h1 class="game-title text-yellow-600">いきもの かくれんぼ</h1>
                <p class="game-subtitle">みつけられるかな？</p>
                
                <div id="find-game-targets">
                    <!-- さがす対象リストがJSで入ります -->
                    <!-- ★ おわるボタン追加 -->
                    <button id="find-quit-game" class="absolute top-2 right-2 text-sm font-bold bg-gray-200 text-gray-600 px-3 py-2 rounded-lg hover:bg-gray-300">
                        おわる
                    </button>
                </div>
                
                <div id="find-game-area">
                    <svg id="find-game-svg" viewBox="0 0 400 300" preserveAspectRatio="xMidYMid slice">
                        <!-- SVG背景と動物がJSで入ります -->
                    </svg>
                </div>
            </div>
        </div>
        
        <!-- 5. さがしゲーム 結果画面 -->
        <div id="find-result-screen" class="screen">
            <div class="text-center p-6 sm:p-10 bg-white rounded-2xl shadow-xl max-w-2xl w-full">
                <h2 id="find-result-title" class="text-5xl font-extrabold text-yellow-500 mb-4">ぜんぶ みつけた！</h2>
                <p id="find-result-message" class="text-2xl text-gray-700 mb-8">すごいね！かんさつ めいじん！</p>
                
                <div class="explanation-list">
                    <h3>みつけた「かくれんぼ」の ひみつ</h3>
                    <div id="find-explanation-area" class="space-y-4">
                        <!-- 解説はJSで生成されます -->
                    </div>
                </div>

                <div class="space-y-4">
                    <button id="find-restart-button" class="game-button bg-green-500 hover:bg-green-600">
                        もういちど あそぶ
                    </button>
                    <button id="find-back-button" class="game-button bg-gray-400 hover:bg-gray-500">
                        ゲームを えらぶ
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- 共通モーダル（せいかい/ざんねん/ヒント） -->
    <div id="simple-modal-overlay" class="modal-overlay">
        <div id="simple-modal-content" class="">
            <!-- メッセージはJSで設定 -->
        </div>
    </div>
    
    <!-- 共通 解説モーダル (コネクト/さがし 両方で使う) -->
    <div id="explanation-modal-overlay" class="modal-overlay">
        <div id="explanation-modal-content">
            <p id="explanation-text">ここに解説が入ります。</p>
            <button id="explanation-close-btn" class="game-button bg-blue-500 hover:bg-blue-600">
                つぎへ
            </button>
        </div>
    </div>

    <!-- ランクイン入力モーダル -->
    <div id="ranking-modal-overlay" class="modal-overlay">
        <div id="ranking-modal-content">
            <h2 class="text-3xl font-extrabold text-yellow-500 mb-3">🎉ランクイン！🎉</h2>
            <p id="ranking-modal-time" class="text-xl text-gray-700 mb-4">タイム: 00 びょう</p>
            <p class="text-lg text-gray-600 mb-4">10い いない です！<br>なまえを にゅうりょく してください。</p>
            <input type="text" id="player-name-input" class="w-full p-3 border border-gray-300 rounded-lg text-lg transition-all" placeholder="なまえ (8もじ まで)" maxlength="8">
            <button id="ranking-submit-btn" class="game-button bg-green-500 hover:bg-green-600 mt-5">
                とうろく
            </button>
        </div>
    </div>

    <!-- ★ ゲーム終了 確認モーダル -->
    <div id="confirm-modal-overlay" class="modal-overlay">
        <div id="confirm-modal-content">
            <h3 class="text-xl font-bold mb-4">ほんとうに おわりますか？</h3>
            <p class="text-gray-600 mb-6">いまのゲームは きえてしまいます。</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-btn" class="game-button bg-gray-400 hover:bg-gray-500" style="width: 48%;">つづける</button>
                <button id="confirm-ok-btn" class="game-button bg-red-500 hover:bg-red-600" style="width: 48%;">おわる</button>
            </div>
        </div>
    </div>

    <!-- ★ ランキングリセット 確認モーダル (新規追加) -->
    <div id="confirm-reset-modal" class="modal-overlay">
        <div id="confirm-modal-content"> <!-- 既存のスタイルを流用 -->
            <h3 class="text-xl font-bold mb-4">かくにん</h3>
            <p class="text-gray-600 mb-6">ほんとうに ランキングを ぜんぶ けしますか？<br>けした データは もどりません。</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-reset-cancel-btn" class="game-button bg-gray-400 hover:bg-gray-500" style="width: 48%;">やめる</button>
                <button id="confirm-reset-ok-btn" class="game-button bg-red-500 hover:bg-red-600" style="width: 48%;">けす</button>
            </div>
        </div>
    </div>

    <!-- ★ BGM用 (MuteボタンとAudioタグ) -->
    <button id="mute-toggle-btn" class="fixed bottom-4 right-4 bg-white p-3 rounded-full shadow-lg z-50 text-lg font-bold">
        BGM 🎵
    </button>
    <!-- ★ src を削除 (JSで設定) -->
    <audio id="bgm" loop></audio>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 0. 共通 DOM とロジック ---
            const screens = {
                gameSelect: document.getElementById('game-select-screen'),
                settings: document.getElementById('settings-screen'), // ★ 追加
                connectStart: document.getElementById('connect-start-screen'),
                connectGame: document.getElementById('connect-game-screen'),
                connectResult: document.getElementById('connect-result-screen'),
                findGame: document.getElementById('find-game-screen'),
                findResult: document.getElementById('find-result-screen'),
            };
            
            // 簡易モーダル DOM
            const simpleModalOverlay = document.getElementById('simple-modal-overlay');
            const simpleModalContent = document.getElementById('simple-modal-content');
            
            // 解説モーダル DOM
            const explanationModalOverlay = document.getElementById('explanation-modal-overlay');
            const explanationText = document.getElementById('explanation-text');
            const explanationCloseBtn = document.getElementById('explanation-close-btn');

            // ランクインモーダル DOM
            const rankingModalOverlay = document.getElementById('ranking-modal-overlay');
            const rankingModalTime = document.getElementById('ranking-modal-time');
            const playerNameInput = document.getElementById('player-name-input');
            const rankingSubmitBtn = document.getElementById('ranking-submit-btn');

            // ★ 確認モーダル DOM (終了確認)
            const confirmModalOverlay = document.getElementById('confirm-modal-overlay');
            const confirmOkBtn = document.getElementById('confirm-ok-btn');
            const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
            let confirmModalTarget = ''; // 'connectGame' or 'findGame'

            // ★ BGM DOM
            const bgm = document.getElementById('bgm');
            const muteToggleBtn = document.getElementById('mute-toggle-btn');

            // ★ 設定画面 DOM (新規追加)
            const settingsButton = document.getElementById('settings-button');
            const settingsBackButton = document.getElementById('settings-back-button');
            const volumeSlider = document.getElementById('volume-slider');
            const bgmSelect = document.getElementById('bgm-select');
            const resetRankingBtn = document.getElementById('reset-ranking-btn');
            const confirmResetModal = document.getElementById('confirm-reset-modal');
            const confirmResetOkBtn = document.getElementById('confirm-reset-ok-btn');
            const confirmResetCancelBtn = document.getElementById('confirm-reset-cancel-btn');
            
            // localStorage用キー
            const RANKING_KEY = 'biodiversityGameRanking';
            const VOLUME_KEY = 'biodiversityGameVolume'; // ★ 追加
            const BGM_KEY = 'biodiversityGameBGM'; // ★ 追加

            // 画面切り替え
            function showScreen(screenId) {
                Object.values(screens).forEach(screen => screen.classList.remove('active'));
                screens[screenId].classList.add('active');

                // ★ BGM再生/停止
                if (screenId === 'connectGame' || screenId === 'findGame') {
                    // ゲーム画面で再生
                    if (!bgm.muted && bgm.src) { // ★ src があるか確認
                        bgm.play().catch(e => console.log("BGM再生エラー: ユーザー操作が必要です。"));
                    }
                } else {
                    // それ以外の画面で停止
                    bgm.pause();
                    bgm.currentTime = 0;
                }
            }

            // 簡易モーダル表示（せいかい/ざんねん/ヒント）
            function showSimpleModal(type, message, duration = 1200) {
                simpleModalContent.textContent = message;
                simpleModalContent.className = type === 'success' ? 'success' : 'error';
                simpleModalOverlay.style.display = 'flex';
                
                // ★ duration を 800ms (0.8s) に変更 (不正解時)
                const displayDuration = type === 'error' ? 800 : duration;

                setTimeout(hideSimpleModal, displayDuration);
            }
            function hideSimpleModal() {
                simpleModalOverlay.style.display = 'none';
            }

            // ★ BGM再生/停止/ミュート
            function playBGM() {
                if (bgm.src && bgm.paused && !bgm.muted) { // ★ src があり、ミュートでないか確認
                    bgm.play().catch(e => console.log("BGM play failed:", e));
                }
            }
            function pauseBGM() {
                bgm.pause();
            }
            muteToggleBtn.addEventListener('click', () => {
                bgm.muted = !bgm.muted;
                // ★ ボタンのテキスト変更
                muteToggleBtn.textContent = bgm.muted ? 'BGM 🔇' : 'BGM 🎵';
                
                // ★ ミュートしたら停止、解除したら再生（ゲーム中のみ）
                if (bgm.muted) {
                    pauseBGM();
                } else {
                    if (screens.connectGame.classList.contains('active') || screens.findGame.classList.contains('active')) {
                        playBGM();
                    }
                }
            });

            // ゲーム選択ボタンのリスナー
            document.getElementById('select-connect-game').addEventListener('click', () => showScreen('connectStart'));
            document.getElementById('select-find-game').addEventListener('click', () => initFindGame());
            document.getElementById('connect-back-button').addEventListener('click', () => {
                showScreen('gameSelect');
            });
            // ★ 設定画面リスナー (新規追加)
            settingsButton.addEventListener('click', () => showScreen('settings'));
            settingsBackButton.addEventListener('click', () => showScreen('gameSelect'));

            // ★ 音量スライダーリスナー
            volumeSlider.addEventListener('input', (e) => {
                const volume = e.target.value;
                bgm.volume = volume;
                localStorage.setItem(VOLUME_KEY, volume);
            });

            // ★ BGM選択リスナー
            bgmSelect.addEventListener('change', (e) => {
                const selectedBGM = e.target.value;
                bgm.src = selectedBGM;
                localStorage.setItem(BGM_KEY, selectedBGM);
                // BGMを変更してすぐ再生 (ミュートでなければ)
                if (!bgm.muted && (screens.connectGame.classList.contains('active') || screens.findGame.classList.contains('active'))) {
                    playBGM();
                }
            });

            // ★ ランキングリセットリスナー
            resetRankingBtn.addEventListener('click', () => {
                confirmResetModal.style.display = 'flex';
            });
            confirmResetOkBtn.addEventListener('click', () => {
                localStorage.removeItem(RANKING_KEY);
                displayRanking(); // 表示を更新
                confirmResetModal.style.display = 'none';
            });
            confirmResetCancelBtn.addEventListener('click', () => {
                confirmResetModal.style.display = 'none';
            });

            // ★ 終了確認モーダルリスナー
            confirmCancelBtn.addEventListener('click', () => {
                confirmModalOverlay.style.display = 'none';
                // ゲーム中の場合、タイマーやBGMを再開
                if (confirmModalTarget === 'connectGame') {
                    startConnectTimer(true); // タイマー再開
                    playBGM(); // BGM再開
                } else if (confirmModalTarget === 'findGame') {
                    playBGM(); // BGM再開
                }
            });
            confirmOkBtn.addEventListener('click', () => {
                if (confirmModalTarget === 'connectGame') {
                    showScreen('connectStart');
                } else if (confirmModalTarget === 'findGame') {
                    showScreen('gameSelect');
                }
                confirmModalOverlay.style.display = 'none';
                stopConnectTimer(); // タイマー完全停止
                // showScreenでBGMは停止される
            });


            // --- 1. いきものコネクト（神経衰弱） ---
            const connectGameDoms = {
                board: document.getElementById('connect-game-board'),
                pairsLeft: document.getElementById('pairs-left'),
                timer: document.getElementById('timer'),
                resultTitle: document.getElementById('connect-result-title'),
                resultTime: document.getElementById('connect-result-time'),
                explanationArea: document.getElementById('connect-explanation-area'),
                restartBtn: document.getElementById('connect-restart-button'),
                quitGameBtn: document.getElementById('connect-quit-game'),
            };

            // ★ カードのペア定義（難易度ごとに重複しないように）
            const allPairs = {
                tutorial: [
                    { id: 't1', emoji: '🐸', name: 'カエル', partner: 't2', exp: '「カエル」と「オタマジャクシ」は おなじいきもの（おやこ）だよ。みずのなかから りくのうえに すむばしょが かわるんだ。' },
                    { id: 't2', emoji: '...<br>🐸', name: 'オタマジャクシ', partner: 't1', exp: '「オタマジャクシ」は「カエル」の あかちゃんだよ。おおきくなると てあしが はえてくるんだ。' }
                ],
                easy: [
                    { id: 'e1', emoji: '🦋', name: 'チョウ', partner: 'e2', exp: '「チョウ」は「ようちゅう」が せいちょうした すがただよ。' },
                    { id: 'e2', emoji: '🐛', name: 'ようちゅう', partner: 'e1', exp: '「ようちゅう」は「チョウ」の あかちゃん。はっぱを たべて おおきくなるよ。' },
                    { id: 'e3', emoji: '🐝', name: 'ミツバチ', partner: 'e4', exp: '「ミツバチ」は「はな」の みつを あつめるよ。このとき、かふんを はこんで あげるんだ。（じゅふん）' },
                    { id: 'e4', emoji: '🌸', name: 'はな', partner: 'e3', exp: '「はな」は「ミツバチ」に みつを あげる かわりに、かふんを はこんでもらうよ。' },
                    { id: 'e5', emoji: '🐞', name: 'テントウムシ', partner: 'e6', exp: '「テントウムシ」は「アブラムシ」を たべてくれる、はたけの みかただよ。' },
                    { id: 'e6', emoji: '...<br>🐜', name: 'アブラムシ', partner: 'e5', exp: '「アブラムシ」は しょくぶつの しるを すう ちいさなムシ。テントウムシの ごはんだよ。' },
                    { id: 'e7', emoji: '...<br>🕷️', name: 'クモ', partner: 'e8', exp: '「クモ」は すを はって、つかまえた「コバエ」などの ちいさなムシを たべるよ。' },
                    { id: 'e8', emoji: '...<br>🦟', name: 'コバエ', partner: 'e7', exp: '「コバエ」などの ちいさなムシは、「クモ」の ごはんになるんだ。' },
                    { id: 'e9', emoji: '🍒', name: 'きの み', partner: 'e10', exp: '「きの み」は「クマ」の だいじな たべもの。もりで くらす どうぶつを ささえるよ。' },
                    { id: 'e10', emoji: '🐻', name: 'クマ', partner: 'e9', exp: '「クマ」は「きの み」や さかなを たべて いきているよ。' },
                    { id: 'e11', emoji: '...<br>🐌', name: 'カタツムリ', partner: 'e12', exp: '「カタツムリ」は「アジサイ」の はっぱが だいすき。ジメジメした ところに いるよ。' },
                    { id: 'e12', emoji: '...<br>💠', name: 'アジサイ', partner: 'e11', exp: '「アジサイ」が さく つゆの きせつは、「カタツムリ」も よく みかけるね。' }
                ],
                medium: [
                    { id: 'm1', emoji: '...<br>🐛', name: 'アオムシ', partner: 'm2', exp: '「アオムシ」は「キャベツ」の はっぱを たべて おおきくなる、モンシロチョウの ようちゅうだよ。' },
                    { id: 'm2', emoji: '🥬', name: 'キャベツ', partner: 'm1', exp: '「キャベツ」は「アオムシ」の だいじな ごはんなんだ。' },
                    { id: 'm3', emoji: '...<br>🦗', name: 'バッタ', partner: 'm4', exp: '「バッタ」は「イネ」などの くさを たべて いきているよ。' },
                    { id: 'm4', emoji: '🌾', name: 'イネ', partner: 'm3', exp: '「イネ」は「バッタ」に たべられてしまう ことが あるんだ。' },
                    { id: 'm5', emoji: '...<br>🐜', name: 'アリ', partner: 'm6', exp: '「アリ」は「アブラムシ」が だす あまい しるを もらう かわりに、てきから まもって あげるんだ。（きょうせい）' },
                    { id: 'm6', emoji: '...<br>🐜', name: 'アブラムシ', partner: 'm5', exp: '「アブラムシ」は「アリ」に あまい しるを あげて、まもってもらうよ。（きょうせい）' },
                    { id: 'm7', emoji: '...<br>🪲', name: 'カブトムシ', partner: 'm8', exp: '「カブトムシ」は「クヌギ」などの きの じゅえきが だいすきなんだ。' },
                    { id: 'm8', emoji: '🌳', name: 'クヌギのき', partner: 'm7', exp: '「クヌギのき」が だす じゅえきは、「カブトムシ」たちの ごちそうだよ。' },
                    { id: 'm9', emoji: '...<br>🦎', name: 'トカゲ', partner: 'm10', exp: '「トカゲ」は「バッタ」などの ちいさなムシを つかまえて たべるよ。' },
                    { id: 'm10', emoji: '...<br>🦗', name: 'バッタ', partner: 'm9', exp: '「バッタ」は くさを たべるけど、「トカゲ」に たべられてしまう ことも あるんだ。' },
                    { id: 'm11', emoji: '🦅', name: 'タカ', partner: 'm12', exp: '「タカ」は とても めが よくて、そらから「ヘビ」を みつけて つかまえるよ。' },
                    { id: 'm12', emoji: '🐍', name: 'ヘビ', partner: 'm11', exp: '「ヘビ」は カエルや ネズミを たべるけど、「タカ」に たべられてしまう ことも あるんだ。' },
                    { id: 'm13', emoji: '...<br>🦉', name: 'フクロウ', partner: 'm14', exp: '「フクロウ」は よるに かつどうし、「ネズミ」などを つかまえて たべるよ。' },
                    { id: 'm14', emoji: '...<br>🐁', name: 'ネズミ', partner: 'm13', exp: '「ネズミ」は「フクロウ」や ヘビ、タカなど、いろいろな どうぶつの ごはんになるんだ。' },
                    { id: 'm15', emoji: '...<br>🍂', name: 'おちば', partner: 'm16', exp: '「おちば」は「ダンゴムシ」や ミミズに ぶんかいされて、つちの えいように なるよ。' },
                    { id: 'm16', emoji: '...<br>⚫', name: 'ダンゴムシ', partner: 'm15', exp: '「ダンゴムシ」は「おちば」を たべて、つちを ゆたかに する「おそうじやさん」なんだ。' }
                ],
                hard: [
                    { id: 'h1', emoji: '🍄', name: 'キノコ', partner: 'h2', exp: '「キノコ」や「カビ」は、しんだ きを ぶんかいして、つちに えいようを もどすよ。' },
                    { id: 'h2', emoji: '...<br>🌲', name: 'しんだ き', partner: 'h1', exp: '「しんだ き」は、「キノコ」や カビ、ムシたちに ぶんかいされて、つちに かえるんだ。' },
                    { id: 'h3', emoji: '...<br>💧', name: 'みずたまり', partner: 'h4', exp: '「みずたまり」は「ボウフラ」が そだつ ばしょ。これが ないと カは うまれないよ。' },
                    { id: 'h4', emoji: '...<br>🦟', name: 'ボウフラ', partner: 'h3', exp: '「ボウフラ」は カの あかちゃん。「みずたまり」などの ちいさな みずたまりで そだつよ。' },
                    { id: 'h5', emoji: '...<br>🐟', name: 'メダカ', partner: 'h6', exp: '「メダカ」は「ボウフラ」を たべてくれる、やくにたつ さかななんだ。' },
                    { id: 'h6', emoji: '...<br>🦟', name: 'ボウフラ', partner: 'h5', exp: '「ボウフラ」は「メダカ」の ごはんの ひとつだよ。' },
                    { id: 'h7', emoji: '...<br>☀️', name: 'たいよう', partner: 'h8', exp: '「たいよう」の ひかりは、しょくぶつが「こうごうせい」で えいようを つくるのに ひつなんだ。' },
                    { id: 'h8', emoji: '🌿', name: 'しょくぶつ', partner: 'h7', exp: '「しょくぶつ」は「たいよう」の ひかりを あびて、みずと くうきの にさんかたんそから えいようを つくるよ。' },
                    { id: 'h9', emoji: '...<br>🦇', name: 'コウモリ', partner: 'h10', exp: '「コウモリ」は ちょうおんぱを だし、はねかえってきた おとで「ガ」などの ばしょを みつけて つかまえるよ。' },
                    { id: 'h10', emoji: '...<br>🦋', name: 'ガ', partner: 'h9', exp: 'よるに とぶ「ガ」は、「コウモリ」の ごはんになるんだ。' },
                    { id: 'h11', emoji: '...<br>💩', name: 'どうぶつのフン', partner: 'h12', exp: '「どうぶつのフン」は、「フンコロガシ」などのムシに ぶんかいされて、つちの えいように なるよ。' },
                    { id: 'h12', emoji: '...<br>🪲', name: 'フンコロガシ', partner: 'h11', exp: '「フンコロガシ」は「どうぶつのフン」を だんごにして はこび、たべたり たまごを うんだり するよ。' },
                    { id: 'h13', emoji: '...<br>🌊', name: 'うみ', partner: 'h14', exp: '「うみ」には「サンゴ」が いて、ちいさな さかなたちの かくれがに なっているよ。' },
                    { id: 'h14', emoji: '...<br>🐠', name: 'ちいさな さかな', partner: 'h13', exp: '「ちいさな さかな」は、「うみ」の なかの サンゴしょうを かくれがにして くらしているよ。' },
                    { id: 'h15', emoji: '...<br>🦅', name: 'ワシ', partner: 'h16', exp: '「ワシ」は「ウサギ」を つかまえて たべるよ。しぜんの バランスを たもつ やくわりが あるんだ。' },
                    { id: 'h16', emoji: '...<br>🐇', name: 'ウサギ', partner: 'h15', exp: '「ウサギ」は くさを たべるけど、「ワシ」などの どうぶつに たべられる ことも あるよ。' },
                    { id: 'h17', emoji: '...<br>🌸', name: 'サクラ', partner: 'h18', exp: '「サクラ」の はなびらが ちると、つぎは「はっぱ」が でてきて、ひかりを あつめるよ。' },
                    { id: 'h18', emoji: '...<br>🍃', name: 'サクラのはっぱ', partner: 'h17', exp: '「サクラのはっぱ」は、はるに はなが おわった あと、なつの あいだに えいようを つくるんだ。' },
                    { id: 'h19', emoji: '...<br>🌰', name: 'ドングリ', partner: 'h20', exp: '「ドングリ」は「カシワ」などの きの み。リスや イノシシの たべものに なるよ。' },
                    { id: 'h20', emoji: '...<br>🌳', name: 'カシワのき', partner: 'h19', exp: '「カシワのき」は、あきに「ドングリ」の みを つけるんだ。' }
                ]
            };
            
            let firstCard = null;
            let secondCard = null;
            let lockBoard = false; // カード操作をロック
            let pairsToMatch = 0;
            let matchedPairs = 0;
            let timerInterval = null;
            let seconds = 0;
            let currentDifficulty = '';
            let currentExplanations = [];
            let wrongStreak = 0; // ★ 不正解カウント

            // ★ ランキング取得
            function getRanking(difficulty) {
                const rankings = JSON.parse(localStorage.getItem(RANKING_KEY)) || {};
                return rankings[difficulty] || [];
            }
            // ★ ランキング表示
            function displayRanking() {
                const difficulties = ['easy', 'medium', 'hard'];
                difficulties.forEach(diff => {
                    const rankingList = document.getElementById(`ranking-list-${diff}`);
                    rankingList.innerHTML = '';
                    const rankings = getRanking(diff);
                    if (rankings.length === 0) {
                        rankingList.innerHTML = '<li class="text-gray-500 italic p-2">まだ きろくが ありません</li>';
                    } else {
                        rankings.forEach((rank, index) => {
                            const li = document.createElement('li');
                            li.innerHTML = `<span class="rank-name">${index + 1}. ${rank.name}</span> <span class="rank-time">${rank.time} びょう</span>`;
                            rankingList.appendChild(li);
                        });
                    }
                });
            }

            // ゲーム初期化
            function initConnectGame(difficulty) {
                currentDifficulty = difficulty;
                currentExplanations = [];
                connectGameDoms.board.innerHTML = '';
                connectGameDoms.board.className = 'grid gap-2 sm:gap-4'; // クラスリセット
                connectGameDoms.board.classList.add(`grid-${difficulty}`);
                
                firstCard = null;
                secondCard = null;
                lockBoard = false;
                matchedPairs = 0;
                wrongStreak = 0;
                
                let cardsData = [];
                if (difficulty === 'tutorial') {
                    cardsData = [...allPairs.tutorial];
                } else if (difficulty === 'easy') {
                    cardsData = [...allPairs.easy];
                } else if (difficulty === 'medium') {
                    cardsData = [...allPairs.medium];
                } else if (difficulty === 'hard') {
                    cardsData = [...allPairs.hard];
                }
                
                pairsToMatch = cardsData.length / 2;
                connectGameDoms.pairsLeft.textContent = pairsToMatch;

                const shuffledCards = shuffleArray(cardsData);
                createBoard(shuffledCards);
                
                showScreen('connectGame');
                startConnectTimer(false); // タイマーを新規開始
            }
            
            // 配列シャッフル (Fisher-Yates)
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            // ボード作成
            function createBoard(cardsData) {
                cardsData.forEach(cardData => {
                    const card = document.createElement('div');
                    card.classList.add('card');
                    card.dataset.id = cardData.id;
                    card.dataset.partner = cardData.partner;
                    card.dataset.name = cardData.name;
                    card.dataset.emoji = cardData.emoji;
                    card.dataset.exp = cardData.exp;

                    card.innerHTML = `
                        <div class="card-inner">
                            <div class="card-face card-back">🤝</div>
                            <div class="card-face card-front">${cardData.emoji}</div>
                        </div>
                    `;
                    card.addEventListener('click', () => handleCardClick(card));
                    connectGameDoms.board.appendChild(card);
                });
            }

            // カードクリック処理
            function handleCardClick(clickedCard) {
                if (lockBoard || clickedCard === firstCard || clickedCard.classList.contains('is-matched')) {
                    return;
                }
                
                clickedCard.classList.add('is-flipped');

                if (!firstCard) {
                    firstCard = clickedCard;
                    return;
                }

                secondCard = clickedCard;
                lockBoard = true; // 2枚めくったらロック
                
                // ★ 少し待ってから判定
                setTimeout(checkForMatch, 500);
            }

            // ペア判定
            function checkForMatch() {
                const isMatch = firstCard.dataset.id === secondCard.dataset.partner;
                
                if (isMatch) {
                    // ★ 正解時
                    wrongStreak = 0; // 不正解カウントリセット
                    showSimpleModal('success', 'せいかい！', 500); // すぐ消す
                    
                    // ★ すぐに解説表示
                    const exp1 = `<b>${firstCard.dataset.name} (${firstCard.dataset.emoji})</b>:<br>${firstCard.dataset.exp}`;
                    const exp2 = `<b>${secondCard.dataset.name} (${secondCard.dataset.emoji})</b>:<br>${secondCard.dataset.exp}`;
                    // ペアの解説をキューに入れる
                    currentExplanations.push({exp1, exp2});
                    
                    // 0.5秒待ってから解説モーダル表示
                    setTimeout(showNextExplanation, 500);
                    
                } else {
                    // ★ 不正解時
                    wrongStreak++;
                    showSimpleModal('error', 'ざんねん…'); // 0.8秒表示
                    // 0.8秒待ってから裏返す
                    setTimeout(unflipCards, 800);
                    
                    // ★ 5回連続で間違えたらヒント
                    if (wrongStreak >= 5) {
                        wrongStreak = 0;
                        setTimeout(showHint, 1000); // 1秒後
                    }
                }
            }
            
            // ★ 解説モーダルを順次表示
            function showNextExplanation() {
                if (currentExplanations.length > 0) {
                    const pairExp = currentExplanations.shift(); // 最初の解説を取り出す
                    explanationText.innerHTML = `${pairExp.exp1}<br><br>${pairExp.exp2}`;
                    explanationModalOverlay.style.display = 'flex';
                } else {
                    // すべての解説が終わったら
                    // マッチしたカードを非表示にし、リセット
                    firstCard.classList.add('is-matched');
                    secondCard.classList.add('is-matched');
                    matchedPairs++;
                    connectGameDoms.pairsLeft.textContent = pairsToMatch - matchedPairs;
                    resetBoard();
                    
                    // 全ペア揃ったらゲーム終了
                    if (matchedPairs === pairsToMatch) {
                        setTimeout(showConnectResult, 500);
                    }
                }
            }
            
            // 解説モーダルの閉じるボタン
            explanationCloseBtn.addEventListener('click', () => {
                explanationModalOverlay.style.display = 'none';
                // 次の解説があるか、なければゲームを続行
                showNextExplanation();
            });

            // カードを裏返す
            function unflipCards() {
                firstCard.classList.remove('is-flipped');
                secondCard.classList.remove('is-flipped');
                resetBoard();
            }

            // ボードリセット
            function resetBoard() {
                [firstCard, secondCard] = [null, null];
                lockBoard = false;
            }

            // ★ ヒント表示
            function showHint() {
                showSimpleModal('success', 'ヒント！💡', 1500);
                // まだマッチしていないカードをすべて取得
                const unmatchedCards = Array.from(document.querySelectorAll('.card:not(.is-matched)'));
                if (unmatchedCards.length > 0) {
                    // ランダムに1枚選ぶ
                    const hintCard1 = unmatchedCards[Math.floor(Math.random() * unmatchedCards.length)];
                    // そのパートナーを探す
                    const partnerId = hintCard1.dataset.partner;
                    const hintCard2 = document.querySelector(`.card[data-id="${partnerId}"]`);
                    
                    if (hintCard2) {
                        // 2枚のカードを光らせる
                        hintCard1.classList.add('is-hinting');
                        hintCard2.classList.add('is-hinting');
                        setTimeout(() => {
                            hintCard1.classList.remove('is-hinting');
                            hintCard2.classList.remove('is-hinting');
                        }, 1500); // 1.5秒光らせる
                    }
                }
            }

            // 結果表示
            function showConnectResult() {
                stopConnectTimer();
                showScreen('connectResult');
                
                const timeTaken = seconds;
                connectGameDoms.resultTitle.textContent = 'クリア！🎉';
                connectGameDoms.resultTime.textContent = `かかったじかん: ${timeTaken} びょう`;
                
                // 解説エリアの生成
                connectGameDoms.explanationArea.innerHTML = '';
                const allCardsData = allPairs[currentDifficulty];
                const explanationsToShow = [];
                // 偶数インデックス（ペアの片方）だけループ
                for (let i = 0; i < allCardsData.length; i += 2) {
                    const card1 = allCardsData[i];
                    const card2 = allPairs[currentDifficulty].find(c => c.id === card1.partner);
                    if (card2) {
                        const expHtml = `
                            <div class="p-3 bg-white rounded-lg shadow-sm border border-gray-200">
                                <b>${card1.name} (${card1.emoji}) 🤝 ${card2.name} (${card2.emoji})</b><br>
                                <span class="text-sm text-gray-700">${card1.exp}</span>
                            </div>
                        `;
                        explanationsToShow.push(expHtml);
                    }
                }
                connectGameDoms.explanationArea.innerHTML = explanationsToShow.join('');

                // チュートリアル以外ならランキングチェック
                if (currentDifficulty !== 'tutorial') {
                    checkRanking(timeTaken, currentDifficulty);
                }
            }

            // ★ ランキングチェック
            function checkRanking(time, difficulty) {
                const rankings = getRanking(difficulty);
                if (rankings.length < 10 || time < rankings[rankings.length - 1].time) {
                    // ランクイン
                    rankingModalTime.textContent = `タイム: ${time} びょう`;
                    rankingModalOverlay.style.display = 'flex';
                }
            }

            // ★ ランキング保存
            function saveRanking(name, time, difficulty) {
                const allRankings = JSON.parse(localStorage.getItem(RANKING_KEY)) || {};
                const rankings = allRankings[difficulty] || [];
                
                const newScore = { name: name || 'ななしさん', time: time };
                rankings.push(newScore);
                
                // タイムで昇順ソート
                rankings.sort((a, b) => a.time - b.time);
                
                // 10位まで保持
                allRankings[difficulty] = rankings.slice(0, 10);
                
                localStorage.setItem(RANKING_KEY, JSON.stringify(allRankings));
            }

            // ★ ランキング登録処理
            function handleRankingSubmit() {
                const name = playerNameInput.value;
                const time = seconds;
                
                if (!name || name.trim() === '') {
                    // ★ 修正: 'break;' は無効。'return;' を使い、フィードバックを追加。
                    playerNameInput.classList.add('is-invalid');
                    setTimeout(() => {
                        playerNameInput.classList.remove('is-invalid');
                    }, 500); // 0.5秒後にクラスを削除
                    return; 
                }

                saveRanking(name, time, currentDifficulty);
                rankingModalOverlay.style.display = 'none';
                playerNameInput.value = '';
                displayRanking(); // スタート画面のランキングを更新
            }

            // タイマー
            function startConnectTimer(isResume) {
                if (!isResume) {
                    seconds = 0; // 新規スタート
                }
                connectGameDoms.timer.textContent = seconds;
                // 既存のタイマーがあれば停止
                if(timerInterval) clearInterval(timerInterval);
                
                timerInterval = setInterval(() => {
                    seconds++;
                    connectGameDoms.timer.textContent = seconds;
                }, 1000);
            }
            function stopConnectTimer() {
                clearInterval(timerInterval);
                timerInterval = null; // タイマーIDをリセット
            }

            // --- コネクトゲーム リスナー ---
            document.querySelectorAll('.difficulty-btn').forEach(button => {
                button.addEventListener('click', () => {
                    initConnectGame(button.dataset.difficulty);
                });
            });
            rankingSubmitBtn.addEventListener('click', handleRankingSubmit);
            connectGameDoms.restartBtn.addEventListener('click', () => {
                showScreen('connectStart');
            });
            // ★ おわるボタン
            connectGameDoms.quitGameBtn.addEventListener('click', () => {
                confirmModalTarget = 'connectGame';
                confirmModalOverlay.style.display = 'flex';
                pauseBGM(); // 確認中はBGM停止
                stopConnectTimer(); // 確認中はタイマー停止
            });

            // --- 2. いきもの かくれんぼ ---
            const findGameDoms = {
                targets: document.getElementById('find-game-targets'),
                svg: document.getElementById('find-game-svg'),
                resultTitle: document.getElementById('find-result-title'),
                resultMsg: document.getElementById('find-result-message'),
                expArea: document.getElementById('find-explanation-area'),
                restartBtn: document.getElementById('find-restart-button'),
                backBtn: document.getElementById('find-back-button'),
                quitGameBtn: document.getElementById('find-quit-game'),
            };

            const findGameData = {
                // 背景
                background: `<rect width="400" height="300" fill="#228B22" />` + // 森
                            `<rect width="400" height="150" y="150" fill="#8FBC8F" />` + // 草むら
                            `<path d="M50 150 Q 80 100 100 150 T 150 150 T 200 150 T 250 150 T 300 150 T 350 150" fill="none" stroke="#556B2F" stroke-width="2" />` + // つる
                            `<circle cx="350" cy="50" r="30" fill="#FFD700" />`, // 太陽
                // 探すいきもの
                animals: [
                    { id: 'nanafu', name: 'ナナフシ', hint: 'えだ？ いいえ、ムシです', exp: '「ナナフシ」は、ほそながい からだで きの えだに そっくり！てきから みを まもるよ。（ぎたい）', svg: `<path d="M100 120 L140 130 M110 123 L115 115 M130 127 L135 120" stroke="#8B4513" stroke-width="4" transform="rotate(15 120 125)" class="target-animal" />`},
                    { id: 'cho', name: 'コノハチョウ', hint: 'かれた はっぱ？', exp: '「コノハチョウ」は、はねを とじると まるで かれは！てきを あざむくよ。（ぎたい）', svg: `<path d="M200 200 Q 220 180 230 200 Q 220 220 200 200 M230 200 Q 240 180 250 200 Q 240 220 230 200" fill="#A0522D" transform="rotate(-30 225 200)" class="target-animal" />`},
                    { id: 'batta', name: 'バッタ', hint: 'くさと おなじ いろ', exp: '「バッタ」は くさむらと おなじ みどりいろ。てきに みつかり にくいね。（ほごしょく）', svg: `<path d="M280 250 Q 290 240 300 250 L 295 255 L 300 260 Q 290 250 280 250 M 285 245 L 290 240" fill="#32CD32" stroke="#2E8B57" stroke-width="1" class="target-animal" />`},
                    { id: 'ga', name: 'ガ (せいちゅう)', hint: 'きの みきに とまってる', exp: '「ガ」の なかまは、きの みきや かれはに にた もようの はねを もつよ。（ほごしょく）', svg: `<path d="M80 50 L100 60 L80 70 Q 70 60 80 50" fill="#A9A9A9" transform="rotate(90 80 60)" class="target-animal" />`},
                    { id: 'imomushi', name: 'イモムシ', hint: 'はっぱと おなじ いろ', exp: '「イモムシ」は、じぶんが たべる はっぱと おなじ みどりいろ。とりから みを まもるよ。（ほごしょく）', svg: `<path d="M140 150 Q 145 145 150 150 Q 155 145 160 150 Q 165 145 170 150" fill="none" stroke="#7CFC00" stroke-width="5" class="target-animal" />`},
                ],
                foundCount: 0
            };

            function initFindGame() {
                findGameDoms.svg.innerHTML = findGameData.background;
                findGameDoms.targets.innerHTML = `<h3 class="font-bold text-gray-700">さがしてみよう:</h3>`; // リセット
                
                findGameData.foundCount = 0;
                const shuffledAnimals = shuffleArray([...findGameData.animals]); // 毎回配置をシャッフル

                shuffledAnimals.forEach(animal => {
                    // 1. リストに追加
                    const targetItem = document.createElement('div');
                    targetItem.id = `target-${animal.id}`;
                    targetItem.className = 'target-item';
                    targetItem.textContent = `・ ${animal.hint}`;
                    findGameDoms.targets.appendChild(targetItem);
                    
                    // 2. SVGに追加
                    findGameDoms.svg.innerHTML += animal.svg;
                });
                
                // 3. おわるボタンを追加
                findGameDoms.targets.appendChild(findGameDoms.quitGameBtn);

                // 4. SVG内の動物にクリックイベント設定
                findGameDoms.svg.querySelectorAll('.target-animal').forEach((animalEl, index) => {
                    // SVGに追加した順（＝shuffledAnimalsの順）にデータを取得
                    const animalData = shuffledAnimals[index]; 
                    
                    // animalData.id を使って、元の animals 配列から正しいデータを引き当てる
                    // (シャッフルされているため、インデックスではなくidで照合する)
                    const correctAnimalData = findGameData.animals.find(a => a.id === animalData.id);

                    if (correctAnimalData) {
                        animalEl.dataset.id = correctAnimalData.id;
                        animalEl.dataset.name = correctAnimalData.name;
                        animalEl.dataset.exp = correctAnimalData.exp;
                        
                        animalEl.addEventListener('click', handleAnimalClick);
                    }
                });
                
                showScreen('findGame');
            }

            function handleAnimalClick(event) {
                const clickedAnimal = event.currentTarget;
                if (clickedAnimal.classList.contains('is-found')) return;

                clickedAnimal.classList.add('is-found');
                findGameData.foundCount++;
                
                const id = clickedAnimal.dataset.id;
                const name = clickedAnimal.dataset.name;
                const exp = clickedAnimal.dataset.exp;
                
                // 1. リストを更新
                document.getElementById(`target-${id}`).classList.add('is-found');
                
                // 2. 解説をモーダルで表示
                explanationText.innerHTML = `<b>${name} を みつけた！</b><br><br>${exp}`;
                explanationModalOverlay.style.display = 'flex';
                // ★ 解説モーダルの閉じるボタンは「showNextExplanation」ではなく、
                //    単純に閉じるだけにする（イベントリスナーは共通）
                //    → コネクトゲーム側で showNextExplanation を設定しているので
                //      ここでは何もしなくても大丈夫。

                // 3. 全部見つけたら結果表示
                if (findGameData.foundCount === findGameData.animals.length) {
                    setTimeout(showFindResult, 800); // 解説閉じた後くらい
                }
            }
            
            function showFindResult() {
                showScreen('findResult');
                
                // 解説エリアの生成
                findGameDoms.expArea.innerHTML = '';
                findGameData.animals.forEach(animal => {
                    const expHtml = `
                        <div class="p-3 bg-white rounded-lg shadow-sm border border-gray-200">
                            <b>${animal.name} (${animal.hint})</b><br>
                            <span class="text-sm text-gray-700">${animal.exp}</span>
                        </div>
                    `;
                    findGameDoms.expArea.innerHTML += expHtml;
                });
            }

            // --- さがしゲーム リスナー ---
            findGameDoms.restartBtn.addEventListener('click', initFindGame);
            findGameDoms.backBtn.addEventListener('click', () => {
                showScreen('gameSelect');
            });
            // ★ おわるボタン
            findGameDoms.quitGameBtn.addEventListener('click', () => {
                confirmModalTarget = 'findGame';
                confirmModalOverlay.style.display = 'flex';
                pauseBGM(); // 確認中はBGM停止
            });

            // --- ★ 設定読み込み関数 (新規追加) ---
            function loadSettings() {
                // 音量設定
                const savedVolume = localStorage.getItem(VOLUME_KEY);
                if (savedVolume !== null) {
                    bgm.volume = savedVolume;
                    volumeSlider.value = savedVolume;
                } else {
                    bgm.volume = 0.5; // デフォルト音量
                    volumeSlider.value = 0.5;
                }

                // BGM選択設定
                const savedBGM = localStorage.getItem(BGM_KEY);
                if (savedBGM) {
                    bgmSelect.value = savedBGM;
                    bgm.src = savedBGM;
                } else {
                    bgmSelect.value = 'music.mp3'; // デフォルトBGM
                    bgm.src = 'music.mp3';
                }
                
                // ミュートボタンの初期状態
                muteToggleBtn.textContent = bgm.muted ? 'BGM 🔇' : 'BGM 🎵';
            }


            // --- 初期化 ---
            loadSettings(); // ★ 設定を読み込む
            displayRanking(); // 起動時に全ランキングを表示

        });
    </script>
</body>
</html>

